<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬å†¬æ—… 2025 | Tokyo Trip</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        body { font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif; background-color: #F3F4F6; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        #map-container { z-index: 1; }
        .gps-pulse {
            width: 14px; height: 14px; border: 2px solid #fff; border-radius: 50%;
            background-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in-up 0.4s ease-out forwards; }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative sm:rounded-xl sm:my-4 sm:h-[95vh] sm:border-4 sm:border-slate-100">

        <!-- Header (æ”¹ç‚ºå’–å•¡è‰² #6F4E37) -->
        <header class="bg-[#6F4E37] text-white shrink-0 z-20 shadow-md">
            <div class="p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <!-- å´é‚Šæ¬„é¸å–®æŒ‰éˆ• -->
                    <button @click="showTripMenu = true" class="text-orange-100 hover:text-white transition">
                        <i class="ph-bold ph-list text-2xl"></i>
                    </button>
                    <div class="overflow-hidden">
                        <h1 class="text-xl font-bold tracking-wide flex items-center gap-2 truncate">
                            {{ setup.destination || 'æ—…éŠè¨ˆç•«' }} <i class="ph-fill ph-airplane-tilt text-sm opacity-70"></i>
                        </h1>
                        <p class="text-xs text-orange-100 mt-0.5 font-light tracking-wider truncate">é»æ“Šä¸‹æ–¹æ—¥æœŸåˆ‡æ›è¡Œç¨‹</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <!-- ç¿»è­¯åŠŸèƒ½æŒ‰éˆ• -->
                    <button @click="viewMode = 'translate'" 
                            :class="viewMode === 'translate' ? 'bg-white text-[#6F4E37] shadow-sm' : 'bg-black/20 text-white/80 hover:bg-black/30'"
                            class="p-2.5 rounded-xl transition-all h-11 w-11 flex items-center justify-center border border-white/10">
                        <i class="ph-bold ph-translate text-xl"></i>
                    </button>

                    <div class="flex bg-black/20 p-1 rounded-lg">
                        <button @click="viewMode = 'plan'" :class="viewMode === 'plan' ? 'bg-white text-[#6F4E37] shadow-sm' : 'text-white/80'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-calendar-check text-lg"></i></button>
                        <button @click="viewMode = 'map'" :class="viewMode === 'map' ? 'bg-white text-[#6F4E37] shadow-sm' : 'text-white/80'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-map-trifold text-lg"></i></button>
                        <button @click="viewMode = 'money'" :class="viewMode === 'money' ? 'bg-white text-[#6F4E37] shadow-sm' : 'text-white/80'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-currency-dollar text-lg"></i></button>
                    </div>
                </div>
            </div>
            <div class="flex overflow-x-auto hide-scroll px-2 pb-3 space-x-3 snap-x">
                <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index" class="snap-center shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-xl cursor-pointer transition-all border-2" :class="currentDayIdx === index ? 'bg-white text-[#6F4E37] border-white shadow-lg scale-105' : 'bg-white/20 text-white border-transparent hover:bg-white/30'">
                    <span class="text-xs font-medium opacity-80">{{ day.shortDate }}</span>
                    <span class="text-lg font-bold">D{{ index + 1 }}</span>
                </div>
                <button @click="addDay" class="shrink-0 w-12 h-16 rounded-xl flex items-center justify-center border-2 border-white/30 border-dashed text-white/70 hover:text-white hover:border-white transition"><i class="ph-bold ph-plus"></i></button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll">
            
            <!-- è¡Œç¨‹è¡¨ (Plan View) -->
            <transition name="fade" mode="out-in">
                <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 pb-24">
                    <div class="bg-white p-4 rounded-2xl shadow-sm mb-4 border border-slate-100 flex justify-between items-start">
                        <div class="flex-1 relative pt-0.5">
                            <!-- éš±å½¢æ—¥æœŸé¸æ“‡å™¨ -->
                            <input type="date" :value="currentDay.fullDate" @change="updateDate($event, currentDay)" class="absolute top-0 left-0 w-40 h-8 opacity-0 z-20 cursor-pointer">
                            <!-- æ—¥æœŸé¡¯ç¤º -->
                            <input v-model="currentDay.date" class="text-xl font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0 w-full relative z-10 pointer-events-none" placeholder="Day 1 (é»æ“Šè¨­å®š)">
                            <input v-model="currentDay.title" class="text-sm text-slate-500 bg-transparent border-b border-dashed border-slate-300 focus:border-[#6F4E37] focus:outline-none w-full mt-1" placeholder="è¼¸å…¥ç•¶æ—¥ä¸»é¡Œ">
                        </div>
                        <!-- å¤©æ°£é¡¯ç¤º -->
                        <div class="flex flex-col items-end pl-2">
                            <div v-if="weatherDisplay" class="text-right">
                                <div class="flex items-center justify-end gap-1 text-indigo-600">
                                    <i :class="['ph-duotone', weatherDisplay.icon, 'text-2xl']"></i>
                                    <span class="text-xl font-bold font-mono whitespace-nowrap">{{ weatherDisplay.temp }}</span>
                                </div>
                                <div class="text-[10px] text-slate-400 flex items-center gap-1 justify-end mt-0.5">
                                    <i :class="weatherDisplay.isForecast ? 'ph-bold ph-calendar' : 'ph-bold ph-map-pin'"></i>
                                    {{ weatherDisplay.label }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- èˆªç­å¡ç‰‡ (ç¶“å…¸æ¨£å¼ï¼šä¿ç•™è—/ç´«æ¼¸å±¤) -->
                    <!-- Day 1: æŠµé” -->
                    <div v-if="currentDayIdx === 0 && currentDay.flight" class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-4 text-white shadow-lg mb-6 relative overflow-hidden">
                        <i class="ph-duotone ph-airplane-takeoff absolute -right-4 -bottom-4 text-9xl opacity-10"></i>
                        <div class="flex justify-between items-end mb-2">
                            <div class="text-center">
                                <div class="text-2xl font-bold">{{ currentDay.flight.startTime }}</div>
                                <div class="text-xs opacity-80">{{ currentDay.flight.startAirport }}</div>
                            </div>
                            <div class="flex flex-col items-center flex-1 px-4">
                                <span class="text-xs font-mono tracking-widest opacity-80">{{ currentDay.flight.number }}</span>
                                <div class="w-full h-0.5 bg-white/30 relative my-1">
                                    <div class="absolute right-0 -top-1 w-2 h-2 bg-white rounded-full"></div>
                                </div>
                                <span class="text-[10px] text-teal-100">æŠµé”æ±äº¬</span>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">{{ currentDay.flight.endTime }}</div>
                                <div class="text-xs opacity-80">{{ currentDay.flight.endAirport }}</div>
                            </div>
                        </div>
                        <!-- å‚™è¨» (è‹¥æœ‰) -->
                        <div v-if="currentDay.flight.note" class="bg-white/10 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <i class="ph-fill ph-info"></i> {{ currentDay.flight.note }}
                        </div>
                    </div>

                    <!-- Day 5: å‡ºç™¼ -->
                    <div v-if="currentDayIdx === 4 && currentDay.flight" class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-4 text-white shadow-lg mb-6 relative overflow-hidden">
                        <i class="ph-duotone ph-airplane-landing absolute -right-4 -bottom-4 text-9xl opacity-10"></i>
                        <div class="flex justify-between items-end mb-2">
                            <div class="text-center">
                                <div class="text-2xl font-bold">{{ currentDay.flight.startTime }}</div>
                                <div class="text-xs opacity-80">{{ currentDay.flight.startAirport }}</div>
                            </div>
                            <div class="flex flex-col items-center flex-1 px-4">
                                <span class="text-xs font-mono tracking-widest opacity-80">{{ currentDay.flight.number }}</span>
                                <div class="w-full h-0.5 bg-white/30 relative my-1">
                                    <div class="absolute right-0 -top-1 w-2 h-2 bg-white rounded-full"></div>
                                </div>
                                <span class="text-[10px] text-purple-100">è¿”å›å°åŒ—</span>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">{{ currentDay.flight.endTime }}</div>
                                <div class="text-xs opacity-80">{{ currentDay.flight.endAirport }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- è¡Œç¨‹åˆ—è¡¨ -->
                    <div class="relative pl-4 border-l-2 border-stone-200 space-y-8">
                        <div v-for="(item, idx) in currentDay.items" :key="idx" class="relative group">
                            <div class="absolute -left-[21px] top-3 w-3 h-3 rounded-full border-2 border-white shadow-sm" :class="getDotColor(item.type)"></div>
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                                <div class="flex flex-col gap-2">
                                    <div class="flex items-start gap-3">
                                        <!-- æ™‚é–“è¼¸å…¥å¡Š -->
                                        <div class="flex flex-col items-center w-20 shrink-0 gap-2">
                                            <div class="relative flex flex-col items-center justify-center bg-slate-50 border border-slate-200 rounded-xl p-1 w-full h-16 cursor-pointer hover:bg-[#6F4E37]/10 hover:border-[#6F4E37]/30 transition group/time">
                                                <span class="text-[10px] font-medium text-slate-400 group-hover/time:text-[#6F4E37]">{{ getTimePeriod(item.time) }}</span>
                                                <span class="text-xl font-bold text-slate-700 group-hover/time:text-[#6F4E37] leading-none font-mono tracking-tight">{{ item.time || '--:--' }}</span>
                                                <input v-model="item.time" type="time" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                            </div>
                                            <select v-model="item.type" class="text-[10px] bg-white border border-slate-200 rounded-md py-1 px-1 w-full text-center">
                                                <option value="spot">ğŸ“ æ™¯é»</option>
                                                <option value="food">ğŸ´ ç¾é£Ÿ</option>
                                                <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                                <option value="transport">ğŸš‡ äº¤é€š</option>
                                                <option value="flight">âœˆï¸ èˆªç­</option>
                                            </select>
                                        </div>
                                        <!-- å…§å®¹è¼¸å…¥ -->
                                        <div class="flex-1 min-w-0 pt-1">
                                            <input v-model="item.activity" class="block w-full font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0" placeholder="è¡Œç¨‹åç¨±...">
                                            <div class="flex items-center gap-1 mt-1">
                                                <i class="ph-fill ph-map-pin text-[#6F4E37] text-xs shrink-0"></i>
                                                <input v-model="item.location" class="flex-1 text-xs text-slate-500 bg-transparent border-none p-0 focus:ring-0 truncate" placeholder="è¼¸å…¥åœ°é» (ä¾‹å¦‚: æ–°å®¿)">
                                            </div>
                                            <div class="flex items-center gap-1 mt-1">
                                                <i class="ph-bold ph-info text-orange-400 text-xs"></i>
                                                <input v-model="item.note" class="flex-1 text-xs text-orange-600/90 bg-transparent border-none p-0 focus:ring-0 truncate" placeholder="å‚™è¨»">
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <a :href="getGoogleMapLink(item.location)" target="_blank" class="text-[#6F4E37] hover:bg-[#6F4E37]/10 p-1 rounded"><i class="ph-bold ph-navigation-arrow"></i></a>
                                            <button @click="removeItem(idx)" class="text-red-300 hover:text-red-500 p-1 rounded"><i class="ph-bold ph-trash"></i></button>
                                        </div>
                                    </div>
                                    
                                    <!-- æ™ºæ…§æ¨è–¦å€ (åƒ…ç¾é£Ÿ) -->
                                    <div v-if="item.type === 'food'" class="p-2 bg-orange-50 rounded-lg border border-orange-100/50 mt-1">
                                        <div class="flex items-center justify-between mb-1">
                                            <p class="text-[10px] font-bold text-orange-400 flex items-center gap-1">
                                                <i class="ph-fill ph-fork-knife"></i> ç¾é£Ÿæ¨è–¦
                                            </p>
                                            <button @click="searchNearby(item, idx)" class="text-[10px] text-[#6F4E37] hover:text-black flex items-center gap-1 bg-white px-2 py-0.5 rounded border border-stone-200 shadow-sm" :disabled="!item.location">
                                                <i v-if="isSearchingRecs && searchTargetIndex === `${currentDayIdx}-${idx}`" class="ph-bold ph-spinner animate-spin"></i>
                                                <i v-else class="ph-bold ph-magnifying-glass"></i>
                                                æœå°‹
                                            </button>
                                        </div>
                                        
                                        <div v-if="recommendationsMap[`${currentDayIdx}-${idx}`] && recommendationsMap[`${currentDayIdx}-${idx}`].length > 0" class="flex flex-wrap gap-2 mt-1">
                                            <button v-for="rec in recommendationsMap[`${currentDayIdx}-${idx}`]" :key="rec.name" @click="applyRecommendation(item, rec)" class="text-[10px] px-2 py-1.5 bg-white border border-orange-200 rounded-lg text-slate-600 hover:bg-orange-500 hover:text-white hover:border-orange-500 transition shadow-sm flex flex-col items-start gap-0.5 max-w-[120px] truncate">
                                                <span class="font-bold truncate w-full text-left">{{ rec.name }}</span>
                                            </button>
                                        </div>
                                        <div v-else-if="!item.location" class="text-[9px] text-slate-400 italic">è«‹å…ˆè¼¸å…¥åœ°é» (ä¾‹å¦‚: æ¾€è°·)ï¼Œå†é»æ“Šæœå°‹</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button @click="addItem" class="flex items-center gap-2 text-[#6F4E37] hover:text-black text-sm font-medium px-2 py-1"><div class="w-2 h-2 bg-[#6F4E37] rounded-full"></div><i class="ph-bold ph-plus"></i> æ–°å¢è¡Œç¨‹</button>
                    </div>
                    <div class="mt-12 pt-6 border-t border-slate-200 text-center">
                        <button @click="removeCurrentDay" class="text-xs text-red-300 hover:text-red-500 flex items-center justify-center gap-1 mx-auto"><i class="ph-bold ph-trash"></i> åˆªé™¤é€™ä¸€å¤©</button>
                    </div>
                </div>
            </transition>

            <!-- åœ°åœ–è¦–åœ– -->
            <div v-if="viewMode === 'map'" class="h-full flex flex-col relative">
                <div id="map" class="flex-1 w-full h-full bg-slate-200 z-0"></div>
                <div v-if="isMapLoading" class="absolute inset-0 bg-white/50 backdrop-blur-sm z-10 flex flex-col items-center justify-center text-[#6F4E37]"><i class="ph-duotone ph-spinner animate-spin text-4xl mb-2"></i><span class="text-xs font-bold">è®€å–ä¸­...</span></div>
                <div class="absolute bottom-4 left-4 right-4 bg-white/90 backdrop-blur rounded-xl p-3 shadow-lg border border-white/50 z-10 flex justify-between items-center">
                    <div class="text-sm font-bold text-slate-800">ğŸ“ {{ currentDay.items.filter(i=>i.location).length }} å€‹åœ°é»</div>
                    <div class="flex gap-2">
                        <button @click="initMap" class="p-2 bg-[#6F4E37]/10 text-[#6F4E37] rounded-lg"><i class="ph-bold ph-arrows-clockwise"></i></button>
                        <button @click="centerOnUser" class="p-2 bg-blue-500 text-white rounded-lg shadow-md"><i class="ph-bold ph-crosshair"></i></button>
                    </div>
                </div>
            </div>

            <!-- åˆ†å¸³è¦–åœ– -->
            <div v-if="viewMode === 'money'" class="p-4 pb-24">
                <div class="bg-[#6F4E37] text-white rounded-2xl p-6 shadow-lg mb-6 text-center relative">
                    <div class="absolute top-4 right-4 flex flex-col items-end">
                        <label class="text-[10px] text-orange-100 mb-1">åŒ¯ç‡ ({{ currencyLabel }})</label>
                        <input v-model.number="exchangeRate" type="number" step="0.001" class="w-16 text-right text-xs text-[#6F4E37] font-bold rounded px-1 py-0.5">
                    </div>
                    <div class="text-sm opacity-80 mb-1">ç¸½æ”¯å‡º Total</div>
                    <div class="text-4xl font-bold font-mono">{{ currencySymbol }} {{ totalExpense.toLocaleString() }}</div>
                    <div class="text-lg font-bold text-orange-100 mt-1">â‰ˆ NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}</div>
                </div>
                <!-- æˆå“¡è¨­å®š -->
                <div class="mb-4 bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                    <div class="text-xs font-bold text-slate-400 mb-2">åˆ†å¸³æˆå“¡ (ç”¨é€—è™Ÿåˆ†éš”)</div>
                    <input v-model="participantsStr" @change="updateParticipants" class="w-full text-sm bg-slate-50 rounded px-2 py-1 border border-slate-200" placeholder="ä¾‹å¦‚: æˆ‘, æœ‹å‹A, æœ‹å‹B">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <div v-for="p in participants" :key="p" class="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                        <div class="text-xs text-slate-400 mb-1">{{ p }} å¢Šä»˜</div>
                        <div class="text-sm font-bold text-[#6F4E37]">{{ currencySymbol }}{{ paidByPerson[p]?.toLocaleString() || 0 }}</div>
                    </div>
                </div>
                <div v-if="settlementPlan.length > 0" class="bg-[#6F4E37]/5 rounded-xl p-4 mb-6 border border-[#6F4E37]/20">
                    <h3 class="text-xs font-bold text-[#6F4E37] uppercase tracking-wide mb-3">çµå¸³å»ºè­°</h3>
                    <div class="space-y-2">
                        <div v-for="(plan, idx) in settlementPlan" :key="idx" class="flex items-center justify-between text-sm bg-white p-2 rounded-lg shadow-sm">
                            <span class="font-bold text-slate-600">{{ plan.from }} <i class="ph-bold ph-arrow-right text-xs"></i> {{ plan.to }}</span>
                            <span class="font-mono font-bold text-[#6F4E37]">{{ currencySymbol }}{{ plan.amount.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-slate-100">
                    <div class="flex gap-2 mb-2">
                        <input v-model="newExpense.item" placeholder="é …ç›®" class="w-[65%] bg-slate-50 border-none rounded-lg text-sm px-3 py-2">
                        <select v-model="newExpense.payer" class="flex-1 bg-slate-50 border-none rounded-lg text-sm px-2 py-2 min-w-0">
                            <option v-for="p in participants" :value="p">{{ p }}</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input v-model.number="newExpense.amount" type="number" :placeholder="currencySymbol + ' é‡‘é¡'" class="w-full bg-slate-50 border-none rounded-lg text-sm pl-3 pr-3 py-2 font-mono">
                        <button @click="addExpense" class="bg-[#6F4E37] hover:bg-[#5D4037] text-white px-4 py-2 rounded-lg font-bold"><i class="ph-bold ph-plus"></i></button>
                    </div>
                </div>
                <div class="space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-[#6F4E37]/10 flex items-center justify-center text-[#6F4E37] text-xs font-bold">{{ exp.payer.charAt(0) }}</div>
                            <div><div class="font-bold text-slate-700 text-sm">{{ exp.item }}</div></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-bold text-slate-700">{{ currencySymbol }}{{ exp.amount.toLocaleString() }}</span>
                            <button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400"><i class="ph-fill ph-x-circle"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¿»è­¯åŠŸèƒ½ -->
            <div v-if="viewMode === 'translate'" class="p-6 h-full flex flex-col justify-center items-center pb-32">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Google ç¿»è­¯æ·å¾‘</h2>
                    <p class="text-sm text-slate-400">è«‹é¸æ“‡æ‚¨éœ€è¦çš„ç¿»è­¯æ¨¡å¼</p>
                </div>
                <div class="w-full mb-4">
                    <a href="https://translate.google.com/?op=images" target="_blank" class="block w-full">
                        <button class="w-full bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left"><div class="text-xs opacity-80 mb-1 tracking-wider">é–‹å•Ÿ Google ç¿»è­¯</div><div class="text-2xl font-bold">ç¶²é ç‰ˆ <i class="ph-bold ph-globe text-sm"></i></div></div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl opacity-60 group-hover:opacity-100"></i>
                            </div>
                        </button>
                    </a>
                </div>
                <div class="w-full mb-4">
                    <a :href="`https://translate.google.com/?sl=zh-TW&tl=${setup.langCode}&op=translate`" target="_blank" class="block w-full">
                        <button class="w-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left"><div class="text-xs opacity-80 mb-1 tracking-wider">æˆ‘èªªä¸­æ–‡ (è½‰{{ setup.langName }})</div><div class="text-2xl font-bold">CH <i class="ph-bold ph-arrow-right text-sm"></i> {{ setup.langCode.toUpperCase() }}</div></div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl opacity-60 group-hover:opacity-100"></i>
                            </div>
                        </button>
                    </a>
                </div>
                <div class="w-full">
                    <a :href="`https://translate.google.com/?sl=${setup.langCode}&tl=zh-TW&op=translate`" target="_blank" class="block w-full">
                        <button class="w-full bg-white border-2 border-slate-200 text-slate-700 rounded-2xl p-6 shadow-sm active:scale-95 transition-transform relative overflow-hidden group hover:border-indigo-300">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left"><div class="text-xs text-slate-400 mb-1 tracking-wider">å°æ–¹èªª{{ setup.langName }} (è½‰ä¸­æ–‡)</div><div class="text-2xl font-bold font-jp">{{ setup.langCode.toUpperCase() }} <i class="ph-bold ph-arrow-right text-sm"></i> CH</div></div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                            </div>
                        </button>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- å´é‚Šæ¬„ (æ—…ç¨‹é¸å–®) -->
        <transition name="slide">
            <div v-if="showTripMenu" class="fixed inset-0 z-50 flex">
                <div class="bg-white w-4/5 max-w-xs h-full shadow-2xl flex flex-col relative z-50 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-800">æˆ‘çš„æ—…ç¨‹</h2>
                        <button @click="showTripMenu = false" class="text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-xl"></i></button>
                    </div>
                    <button @click="createNewTrip" class="w-full py-3 mb-6 border-2 border-dashed border-[#6F4E37] text-[#6F4E37] rounded-xl font-bold hover:bg-[#6F4E37]/10 flex items-center justify-center gap-2">
                        <i class="ph-bold ph-plus-circle"></i> å»ºç«‹æ–°æ—…ç¨‹
                    </button>
                    <div class="flex-1 overflow-y-auto space-y-3 hide-scroll">
                        <div v-for="trip in tripList" :key="trip.id" 
                             @click="switchTrip(trip.id)"
                             class="p-4 rounded-xl border transition cursor-pointer relative group"
                             :class="currentTripId === trip.id ? 'bg-[#6F4E37]/10 border-[#6F4E37] shadow-sm' : 'bg-slate-50 border-transparent hover:bg-slate-100'">
                            <div class="font-bold text-slate-800">{{ trip.destination || 'æœªå‘½åè¡Œç¨‹' }}</div>
                            <div class="text-xs text-slate-400 mt-1">{{ trip.startDate }} â€¢ {{ trip.daysCount }} å¤©</div>
                            <button v-if="tripList.length > 1" @click.stop="deleteTrip(trip.id)" class="absolute right-3 top-3 text-slate-300 hover:text-red-500 p-1"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                </div>
                <div class="flex-1 bg-black/50 backdrop-blur-sm z-40" @click="showTripMenu = false"></div>
            </div>
        </transition>

        <!-- åˆå§‹è¨­å®šè¦–çª— -->
        <div v-if="showSetupModal" class="absolute inset-0 bg-[#6F4E37]/90 backdrop-blur-sm z-50 flex items-center justify-center p-6 animate-fade-in">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-[#6F4E37]/10 rounded-full flex items-center justify-center mx-auto mb-3"><i class="ph-duotone ph-airplane-tilt text-3xl text-[#6F4E37]"></i></div>
                    <h2 class="text-2xl font-bold text-slate-800">å»ºç«‹æ–°æ—…ç¨‹</h2>
                    <p class="text-sm text-slate-400">ç°¡å–®å¹¾æ­¥ï¼Œé–‹å§‹è¦åŠƒæ‚¨çš„å†’éšªï¼</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ç›®çš„åœ° (è‹±æ–‡/ä¸­æ–‡)</label>
                        <div class="relative">
                            <input v-model="setup.destination" @blur="detectRate" type="text" placeholder="ä¾‹å¦‚: Tokyo, Osaka" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#6F4E37] font-bold">
                            <button @click="detectRate" class="absolute right-3 top-3 text-[#6F4E37] hover:text-black"><i class="ph-bold ph-magnifying-glass"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">é–‹å§‹æ—¥æœŸ</label>
                            <input v-model="setup.startDate" type="date" class="h-12 w-full bg-slate-50 border border-slate-200 rounded-xl px-3 text-slate-700 focus:ring-2 focus:ring-[#6F4E37] text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">å¤©æ•¸</label>
                            <input v-model.number="setup.days" type="number" min="1" max="30" class="h-12 w-full bg-slate-50 border border-slate-200 rounded-xl px-3 text-slate-700 focus:ring-2 focus:ring-[#6F4E37] text-center font-bold">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1 flex justify-between"><span>åŒ¯ç‡ ({{ setup.currency || 'å¤–å¹£' }}:å°å¹£)</span><span v-if="isRateLoading" class="text-[#6F4E37] animate-pulse">æŠ“å–ä¸­...</span></label>
                        <input v-model.number="setup.rate" type="number" step="0.001" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#6F4E37] font-mono text-right">
                    </div>
                    <button @click="initTrip" class="w-full bg-[#6F4E37] hover:bg-[#5D4037] text-white font-bold py-3.5 rounded-xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-2 mt-2">é–‹å§‹è¦åŠƒ <i class="ph-bold ph-arrow-right"></i></button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        
        // --- FIREBASE è¨­å®šå€ (é€™è£¡å·²ç¶“å¡«å…¥æ‚¨çš„è¨­å®š) ---
        const useFirebase = true; 
        const firebaseConfig = {
            apiKey: "AIzaSyDwzTYCodPHbpwkvkIFRQ6-S1f3GP3LkX0",
            authDomain: "tokyotrip2025-c3a04.firebaseapp.com",
            projectId: "tokyotrip2025-c3a04",
            storageBucket: "tokyotrip2025-c3a04.firebasestorage.app",
            messagingSenderId: "382628977466",
            appId: "1:382628977466:web:048651923908a837074e03"
        };
        // ------------------------------------

        let appInstance, db, tripRef;
        if (useFirebase) {
            import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js").then(m => {
                appInstance = m.initializeApp(firebaseConfig);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(f => {
                    db = f.getFirestore(appInstance);
                    // Default ref, will be updated in switchTrip
                    tripRef = f.doc(db, "trips", "tokyo_2025_final"); 
                });
            });
        }

        createApp({
            setup() {
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const isOnline = ref(false);
                const isFirebaseReady = ref(false);
                let updatingFromRemote = false;
                let geoWatchId = null;

                // å¤šæ—…ç¨‹
                const showTripMenu = ref(false);
                const tripList = ref([]);
                const currentTripId = ref(null);
                const showSetupModal = ref(false);

                // è³‡æ–™
                const days = ref([]);
                const expenses = ref([]);
                const participants = ref(['è±ªè±ª', 'æŸ”æŸ”']);
                const participantsStr = ref('è±ªè±ª, æŸ”æŸ”');
                const exchangeRate = ref(0.215);
                const newExpense = ref({ item: '', amount: '', payer: 'è±ªè±ª' });

                // æš«å­˜èˆ‡è¨­å®š
                const isRateLoading = ref(false);
                const isMapLoading = ref(false);
                const userLocation = ref(null);
                const weather = ref({ temp: null, icon: 'ph-sun', code: 0, location: '', daily: [] });
                const setup = ref({ destination: 'Tokyo', startDate: '2025-12-05', days: 5, rate: 0.215, currency: 'JPY', langCode: 'ja', langName: 'æ—¥æ–‡' });

                // æ™ºæ…§æ¨è–¦ç³»çµ±
                const recommendationsMap = reactive({});
                const isSearchingRecs = ref(false);
                const searchTargetIndex = ref('');

                // --- Computed ---
                const currentDay = computed(() => days.value[currentDayIdx.value] || {items:[], flight:null, date:'', title:''});
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const paidByPerson = computed(() => {
                    const map = {};
                    participants.value.forEach(p => map[p] = 0);
                    expenses.value.forEach(e => { if (map[e.payer] === undefined) map[e.payer] = 0; map[e.payer] += e.amount; });
                    return map;
                });
                const settlementPlan = computed(() => {
                    if (totalExpense.value === 0) return [];
                    const average = totalExpense.value / participants.value.length;
                    let balances = participants.value.map(p => ({ name: p, val: (paidByPerson.value[p] || 0) - average }));
                    let debtors = balances.filter(b => b.val < -1).sort((a, b) => a.val - b.val);
                    let creditors = balances.filter(b => b.val > 1).sort((a, b) => b.val - a.val);
                    const result = [];
                    let i = 0; let j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let debtor = debtors[i];
                        let creditor = creditors[j];
                        let amount = Math.min(Math.abs(debtor.val), creditor.val);
                        amount = Math.round(amount);
                        if (amount > 0) result.push({ from: debtor.name, to: creditor.name, amount: amount });
                        debtor.val += amount; creditor.val -= amount;
                        if (Math.abs(debtor.val) < 1) i++;
                        if (creditor.val < 1) j++;
                    }
                    return result;
                });
                const currencyLabel = computed(() => setup.value.currency || 'å¤–å¹£');
                const currencySymbol = computed(() => {
                    const map = { 'JPY': 'Â¥', 'CNY': 'Â¥', 'USD': '$', 'EUR': 'â‚¬', 'KRW': 'â‚©', 'GBP': 'Â£', 'TWD': 'NT$', 'HKD': 'HK$', 'THB': 'à¸¿', 'VND': 'â‚«' };
                    return map[setup.value.currency] || '$';
                });
                const weatherDisplay = computed(() => {
                    if (!currentDay.value || !currentDay.value.fullDate || weather.value.daily.length === 0) {
                        return { temp: weather.value.temp !== null ? `${weather.value.temp}Â°` : '--', icon: weather.value.icon || 'ph-sun', label: `${setup.value.destination || 'ç•¶åœ°'} (ç›®å‰)`, isForecast: false };
                    }
                    const targetDate = currentDay.value.fullDate;
                    const idx = weather.value.daily.time.indexOf(targetDate);
                    if (idx !== -1) {
                        const max = Math.round(weather.value.daily.temperature_2m_max[idx]);
                        const min = Math.round(weather.value.daily.temperature_2m_min[idx]);
                        return { temp: `${min}Â° - ${max}Â°`, icon: getWeatherIcon(weather.value.daily.weathercode[idx]), label: `${setup.value.destination} (é å ±)`, isForecast: true };
                    }
                    return { temp: weather.value.temp !== null ? `${weather.value.temp}Â°` : '--', icon: weather.value.icon || 'ph-sun', label: `${setup.value.destination} (ç›®å‰)`, isForecast: false };
                });

                // --- Helpers ---
                const generateId = () => 'trip_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                const getWeatherIcon = (c) => { if (c===0) return 'ph-sun'; if (c<4) return 'ph-cloud-sun'; if (c<50) return 'ph-cloud-fog'; if (c<70) return 'ph-cloud-rain'; return 'ph-cloud'; };
                const getTimePeriod = (t) => { if(!t) return 'æ™‚é–“'; const h=parseInt(t.split(':')[0]); return h<5?'å‡Œæ™¨':h<11?'ä¸Šåˆ':h<14?'ä¸­åˆ':h<18?'ä¸‹åˆ':'æ™šä¸Š'; };
                const toggleFlightCard = () => {
                     if (currentDay.value.flight) { if(confirm('ç§»é™¤èˆªç­?')) currentDay.value.flight = null; }
                     else { currentDay.value.flight = { type: 'arrival', startTime: '10:00', startAirport: 'TPE', number: 'FLIGHT', endTime: '14:00', endAirport: 'DEST', arrivalOffset: 0 }; }
                };
                const getDotColor = (t) => t==='food'?'bg-orange-400':t==='shop'?'bg-pink-400':t==='flight'?'bg-blue-500':'bg-[#6F4E37]';
                const updateParticipants = () => { participants.value = participantsStr.value.split(',').map(s=>s.trim()).filter(s=>s); };
                const updateDate = (e, day) => {
                    const val = e.target.value; if(!val) return;
                    day.fullDate = val;
                    const d = new Date(val);
                    if(isNaN(d.getTime())) return;
                    const w = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
                    const mm = d.getMonth()+1; const dd = d.getDate();
                    day.date = `${mm < 10 ? '0'+mm : mm}/${dd < 10 ? '0'+dd : dd} (${w})`;
                    day.shortDate = `${mm}/${dd}`;
                };

                // --- Core ---
                const addItem = () => currentDay.value.items.push({ time: '', type: 'spot', activity: '', location: '', note: '' });
                const removeItem = (idx) => currentDay.value.items.splice(idx, 1);
                const addDay = () => days.value.push({ date: `Day ${days.value.length+1}`, title: '', items: [] });
                const removeCurrentDay = () => { if(days.value.length>1 && confirm('åˆªé™¤?')) days.value.splice(currentDayIdx.value, 1); };
                const getGoogleMapLink = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';
                const addExpense = () => { if(newExpense.value.item) { expenses.value.unshift({...newExpense.value}); newExpense.value.item=''; newExpense.value.amount=''; }};
                const removeExpense = (idx) => expenses.value.splice(idx, 1);

                // --- LBS æ¨è–¦ ---
                const searchNearby = async (item, idx) => {
                    if (!item.location || item.type !== 'food') return;
                    const key = `${currentDayIdx.value}-${idx}`;
                    searchTargetIndex.value = key;
                    isSearchingRecs.value = true;
                    recommendationsMap[key] = []; 
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}&limit=1`);
                        const geoData = await geoRes.json();
                        if (geoData && geoData.length > 0) {
                            let query = 'restaurant';
                            const finalQuery = `${query} near ${item.location}`;
                            const searchRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(finalQuery)}&limit=4`);
                            const searchData = await searchRes.json();
                            recommendationsMap[key] = searchData.map(place => ({
                                name: place.name || place.display_name.split(',')[0], 
                                location: place.name || place.display_name.split(',')[0],
                                note: 'æ¨è–¦åœ°é»'
                            }));
                            if (recommendationsMap[key].length === 0) recommendationsMap[key] = [{ name: 'ç„¡æ¨è–¦ï¼Œè«‹å˜—è©¦ç²¾ç¢ºåœ°é»', location: item.location, note: '' }];
                        }
                    } catch (e) {} finally { isSearchingRecs.value = false; searchTargetIndex.value = ''; }
                };
                const applyRecommendation = (item, rec) => { item.activity = rec.name; item.location = rec.name; };

                // --- Auto Detect ---
                const countryInfoMap = { 'jp': {c:'JPY',l:'ja',n:'æ—¥æ–‡'}, 'kr': {c:'KRW',l:'ko',n:'éŸ“æ–‡'}, 'us': {c:'USD',l:'en',n:'è‹±æ–‡'}, 'cn': {c:'CNY',l:'zh-CN',n:'ç°¡ä¸­'}, 'th': {c:'THB',l:'th',n:'æ³°æ–‡'} };
                const detectRate = async () => {
                    if(!setup.value.destination) return;
                    isRateLoading.value = true;
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(setup.value.destination)}&limit=1&addressdetails=1`);
                        const geoData = await geoRes.json();
                        if(geoData?.[0]?.address?.country_code) {
                            const info = countryInfoMap[geoData[0].address.country_code.toLowerCase()] || {c:'USD',l:'en',n:'è‹±æ–‡'};
                            setup.value.currency = info.c; setup.value.langCode = info.l; setup.value.langName = info.n;
                            if(info.c === 'TWD') setup.value.rate = 1;
                            else {
                                const rRes = await fetch(`https://api.exchangerate-api.com/v4/latest/${info.c}`);
                                const rData = await rRes.json();
                                if(rData?.rates?.TWD) setup.value.rate = rData.rates.TWD;
                            }
                        }
                    } catch(e) {} finally { isRateLoading.value = false; }
                };

                // --- Weather ---
                const fetchWeather = async (locName) => {
                    try {
                        weather.value.location = locName;
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locName)}&limit=1`);
                        const geoData = await geoRes.json();
                        if(geoData?.[0]) {
                            const {lat, lon} = geoData[0];
                            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&forecast_days=16`);
                            const wData = await wRes.json();
                            weather.value.temp = Math.round(wData.current_weather.temperature);
                            weather.value.icon = getWeatherIcon(wData.current_weather.weathercode);
                            if(wData.daily) weather.value.daily = wData.daily;
                        }
                    } catch(e) { weather.value.temp = '--'; }
                };

                // --- Multi-Trip ---
                const loadTripList = () => {
                    const list = localStorage.getItem('travel_app_index');
                    tripList.value = list ? JSON.parse(list) : [];
                };
                const saveTripList = () => {
                    localStorage.setItem('travel_app_index', JSON.stringify(tripList.value));
                };
                const createNewTrip = () => {
                    setup.value = { destination: '', startDate: new Date().toISOString().split('T')[0], days: 5, rate: 0.215, currency: 'JPY', langCode: 'ja', langName: 'æ—¥æ–‡' };
                    showSetupModal.value = true;
                    showTripMenu.value = false;
                };
                const initTrip = () => {
                    if(!setup.value.destination) { alert('è«‹è¼¸å…¥ç›®çš„åœ°'); return; }
                    const newId = generateId();
                    const newTripMeta = { id: newId, destination: setup.value.destination, startDate: setup.value.startDate, daysCount: setup.value.days };
                    
                    const newDays = [];
                    const start = new Date(setup.value.startDate);
                    const dNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    for(let i=0; i<setup.value.days; i++) {
                        const curr = new Date(start); curr.setDate(start.getDate()+i);
                        const mm = curr.getMonth()+1; const dd = curr.getDate();
                        const yyyy = curr.getFullYear();
                        const fullDate = `${yyyy}-${mm < 10 ? '0'+mm : mm}-${dd < 10 ? '0'+dd : dd}`;
                        newDays.push({
                            date: `${mm < 10 ? '0'+mm : mm}/${dd < 10 ? '0'+dd : dd} (${dNames[curr.getDay()]})`,
                            shortDate: `${mm}/${dd}`,
                            fullDate: fullDate,
                            title: i===0?'æŠµé” & æ¢ç´¢':'è¡Œç¨‹è¦åŠƒ',
                            items: [], flight: null
                        });
                    }

                    localStorage.setItem(`${newId}_days`, JSON.stringify(newDays));
                    localStorage.setItem(`${newId}_exp`, '[]');
                    localStorage.setItem(`${newId}_users`, 'æˆ‘, æ—…ä¼´A');
                    localStorage.setItem(`${newId}_rate`, setup.value.rate.toString());
                    localStorage.setItem(`${newId}_config`, JSON.stringify(setup.value));

                    tripList.value.unshift(newTripMeta);
                    saveTripList();
                    
                    switchTrip(newId);
                    showSetupModal.value = false;
                };
                const deleteTrip = (id) => {
                    if(!confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿç„¡æ³•å¾©åŸã€‚')) return;
                    tripList.value = tripList.value.filter(t => t.id !== id);
                    saveTripList();
                    localStorage.removeItem(`${id}_days`);
                    localStorage.removeItem(`${id}_exp`);
                    localStorage.removeItem(`${id}_users`);
                    localStorage.removeItem(`${id}_rate`);
                    localStorage.removeItem(`${id}_config`);
                    if(currentTripId.value === id) {
                        if(tripList.value.length > 0) switchTrip(tripList.value[0].id);
                        else { days.value=[]; currentTripId.value=null; showSetupModal.value=true; }
                    }
                };
                const switchTrip = (id) => {
                    currentTripId.value = id;
                    showTripMenu.value = false;
                    const lDays = localStorage.getItem(`${id}_days`);
                    const lExp = localStorage.getItem(`${id}_exp`);
                    const lUsers = localStorage.getItem(`${id}_users`);
                    const lRate = localStorage.getItem(`${id}_rate`);
                    const lConf = localStorage.getItem(`${id}_config`);

                    if(lDays) days.value = JSON.parse(lDays);
                    if(lExp) expenses.value = JSON.parse(lExp);
                    if(lUsers) { participantsStr.value = lUsers; updateParticipants(); }
                    if(lRate) exchangeRate.value = parseFloat(lRate);
                    if(lConf) {
                        const conf = JSON.parse(lConf);
                        setup.value = conf;
                        fetchWeather(conf.destination);
                    }
                    // Firebase: Switch tripRef doc
                    if (useFirebase && db && tripRef) {
                         // Update tripRef logic if needed. For now we stick to 'tokyo_2025_final' for the main data.
                         // If full multi-trip sync is needed, logic here needs to update tripRef path based on ID.
                         // For this "Tokyo Final App", we force load the specific data below.
                    }
                };

                // --- Init (Tokyo Final Data) ---
                onMounted(() => {
                    loadTripList();
                    
                    // å¼·åˆ¶è¼‰å…¥æ‚¨çš„æ±äº¬è¡Œç¨‹è³‡æ–™ (Day 1 - Day 5)
                    const tokyoDataDays = [
                        { 
                            date: '12/05 (äº”)', shortDate: '12/05', fullDate: '2025-12-05', title: 'æŠµé”æ±äº¬ & æ°‘å®¿ Check-in', 
                            flight: { type: 'arrival', startTime: '12:10', startAirport: 'TPE', number: 'SL394', endTime: '16:15', endAirport: 'NRT', arrivalOffset: 0, note: '' },
                            items: [
                                { time: '08:30', type: 'transport', activity: 'å‰å¾€æ©Ÿå ´ (è¨ˆç¨‹è»Š+æ©Ÿæ·)', location: 'æ–°åŒ—ç”¢æ¥­åœ’å€ç«™', note: 'è¨ˆç¨‹è»Šè‡³æ©Ÿæ·ç«™ï¼Œæ­ä¹˜ç›´é”è»Š(08:55-09:21)è‡³æ¡ƒæ©ŸT1' },
                                { time: '09:30', type: 'transport', activity: 'æ©Ÿå ´ Check-in', location: 'æ¡ƒåœ’æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', note: 'SL394 (12:10èµ·é£›)' },
                                { time: '16:15', type: 'transport', activity: 'æŠµé”æˆç”°æ©Ÿå ´ T1 (SL394)', location: 'æˆç”°æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', note: '' },
                                { time: '16:45', type: 'transport', activity: 'B1 æ—…éŠæœå‹™ä¸­å¿ƒå…Œæ› Skyliner', location: 'Skyliner & Keisei Information Center', note: 'å…Œæ›ä¾†å›ç¥¨(å›ç¨‹åˆ¸ä¿ç•™)ï¼Œæ­154æ¬¡å¾€é’ç ¥' },
                                { time: '17:19', type: 'transport', activity: 'Skyliner 154æ¬¡ ç™¼è»Š', location: 'æˆç”°ç©ºæ¸¯é§…', note: '17:53 æŠµé”é’ç ¥ç«™' },
                                { time: '17:59', type: 'transport', activity: 'é’ç ¥ç«™è½‰ä¹˜ (äº¬æˆæŠ¼ä¸Šç·š)', location: 'é’ç ¥é§…', note: 'å¾€æŠ¼ä¸Šæ–¹å‘æ™®é€šè»Šï¼Œ18:05 æŠµé”äº¬æˆæ›³èˆŸ' },
                                { time: '18:15', type: 'spot', activity: 'æ°‘å®¿ Check-in (å‡ºç«™åˆ·è¥¿ç“œå¡)', location: '2-chÅme-30-9 HigashimukÅjima, Sumida City', note: '' },
                                { time: '19:00', type: 'food', activity: 'æ™šé¤', location: 'æŠ¼ä¸Šå‘¨é‚Š', note: '' },
                                { time: '19:30', type: 'spot', activity: 'æ±äº¬æ™´ç©ºå¡” & è–èª•å¸‚é›†', location: 'æ±äº¬æ™´ç©ºå¡”', note: 'â˜… å‹™å¿…åœ¨æ­¤(æŠ¼ä¸Šç«™)å…Œæ›æ±äº¬åœ°éµä¸‰æ—¥åˆ¸' }
                            ] 
                        },
                        { 
                            date: '12/06 (å…­)', shortDate: '12/06', fullDate: '2025-12-06', title: 'å¯Œå£«å±±ä¸€æ—¥éŠ & æ±äº¬è»Šç«™å¤œæ™¯', 
                            items: [
                                { time: '05:53', type: 'transport', activity: 'å‰å¾€æœ‰æ¨‚ç”º/æ—¥æ¯”è°·', location: 'äº¬æˆæ›³èˆŸé§…', note: 'æ±æ­¦æ™´ç©ºå¡”ç·š(5:57)â†’å¤§æ‰‹ç”ºâ†’ä¸‰ç”°ç·š(6:24)â†’æ—¥æ¯”è°· (å¯ç”¨é€šç¥¨)' },
                                { time: '06:30', type: 'spot', activity: 'è³éŠ€æ & æ­¥è¡Œè‡³é›†åˆé»', location: 'æ—¥æ¯”è°·å…¬åœ’', note: 'æ•£æ­¥è‡³æ±äº¬è»Šç«™ä¸¸ä¹‹å…§å¤§å»ˆ' },
                                { time: '07:15', type: 'spot', activity: 'å¯Œå£«å±±ä¸€æ—¥éŠ (é›†åˆ)', location: 'ä¸¸ä¹‹å…§å¤§å»ˆ', note: 'â˜… 07:20å‰ ä¸€æ¨“é›†åˆå®Œç•¢' },
                                { time: '18:00', type: 'food', activity: 'æ™šé¤ & è–èª•å¸‚é›†', location: 'æ±äº¬è»Šç«™', note: 'ä¸¸ä¹‹å…§ä»²é€šå»ºç¯‰å»Šé“ã€å¤§å»ˆå¤œæ™¯' },
                                { time: '21:00', type: 'transport', activity: 'è¿”å›æ°‘å®¿', location: 'å¯¶ç”ºé§…', note: 'æ·ºè‰ç·š(21:10)â†’äº¬æˆæ›³èˆŸ(21:27) (å¯ç”¨é€šç¥¨ï¼Œå‡ºç«™åˆ·è¥¿ç“œå¡è£œç¥¨)' }
                            ] 
                        },
                        { 
                            date: '12/07 (æ—¥)', shortDate: '12/07', fullDate: '2025-12-07', title: 'æ·ºè‰æ–‡åŒ– & å…­æœ¬æœ¨è—è¡“å·¡ç¦®', 
                            items: [
                                { time: '08:18', type: 'transport', activity: 'å‰å¾€æ·ºè‰', location: 'æ›³èˆŸé§…', note: 'æ±æ­¦æ™´ç©ºå¡”ç·š(8:18)â†’æ·ºè‰(8:24)' },
                                { time: '08:30', type: 'spot', activity: 'æ·ºè‰å¯º & é›·é–€', location: 'æ·ºè‰å¯º', note: 'ä»²è¦‹ä¸–å•†åº—è¡—é€›è¡—' },
                                { time: '12:00', type: 'food', activity: 'åˆé¤', location: 'æ·ºè‰å‘¨é‚Š', note: '' },
                                { time: '13:00', type: 'transport', activity: 'å‰å¾€å…­æœ¬æœ¨ (æ”¾è¡Œæ)', location: 'æ·ºè‰é§…', note: 'éŠ€åº§ç·šâ†’éŠ€åº§(13:23)â†’è½‰æ—¥æ¯”è°·ç·šâ†’å…­æœ¬æœ¨(13:37) (å¯ç”¨é€šç¥¨)' },
                                { time: '13:30', type: 'spot', activity: 'å…­æœ¬æœ¨è—è¡“æ•£ç­–', location: 'å…­æœ¬æœ¨è”¦å±‹æ›¸åº—', note: 'æ‹æ±äº¬éµå¡”ã€æ£®ç¾è¡“é¤¨ã€21_21ã€åœ‹ç«‹æ–°ç¾è¡“é¤¨' },
                                { time: '15:35', type: 'transport', activity: 'å‰å¾€æ°‘å®¿2', location: 'å…­æœ¬æœ¨é§…å‰', note: 'æ­ä¹˜å·´å£«(å96)â†’ä¸‰ä¹‹æ©‹(Sannohashi) (15:37-15:48)' },
                                { time: '16:00', type: 'spot', activity: 'æ°‘å®¿2 Check-in', location: '2-chÅme-2-18 Minamiazabu, Minato City', note: 'è¿‘éº»å¸ƒåç•ª/ä¸‰ç”°ç«™' },
                                { time: '17:30', type: 'food', activity: 'æ™šé¤', location: 'éº»å¸ƒåç•ª/å…­æœ¬æœ¨', note: '' },
                                { time: '18:30', type: 'spot', activity: 'è¡¨åƒé“ & åŸå®¿é€›è¡—', location: 'è¡¨åƒé“', note: 'Spiral(è‡³19:00)ã€è—ç“¶é’å±±(è‡³19:00)ã€æ ¹æ´¥ç¾è¡“é¤¨(å·²é—œé–€)' },
                                { time: '21:00', type: 'transport', activity: 'è¿”å›æ°‘å®¿', location: 'æ˜æ²»ç¥å®®å‰ã€ˆåŸå®¿ã€‰é§…', note: 'åƒä»£ç”°ç·š(21:05)â†’åœ‹æœƒè­°äº‹å ‚å‰â†’è½‰å—åŒ—ç·šâ†’éº»å¸ƒåç•ª(21:20)' }
                            ]
                        },
                        { 
                            date: '12/08 (ä¸€)', shortDate: '12/08', fullDate: '2025-12-08', title: 'ä»£å®˜å±±æ—©åˆé¤ & æ¾€è°·å¤©éš›ç·š', 
                            items: [
                                { time: '08:30', type: 'transport', activity: 'å‰å¾€ä»£å®˜å±±', location: 'ä¸‰ä¹‹æ©‹(Sannohashi)å…¬è»Šç«™', note: 'æ­ä¹˜å·´å£«(éƒ½06)â†’æ±ä¸‰ä¸ç›®(Higashi 3) (08:37-08:51)' },
                                { time: '09:00', type: 'food', activity: 'Ivy Place æ—©é¤', location: '16-15 SarugakuchÅ, Shibuya', note: 'â˜… Klook å·²è¨‚ä½' },
                                { time: '12:00', type: 'spot', activity: 'ä¸­ç›®é»‘æ•£ç­–', location: 'ä¸­ç›®é»‘', note: 'é€›è¡—è³¼ç‰©' },
                                { time: '13:00', type: 'food', activity: 'åˆé¤', location: 'ä¸­ç›®é»‘å‘¨é‚Š', note: '' },
                                { time: '15:30', type: 'transport', activity: 'å‰å¾€æ¾€è°·', location: 'ä¸­ç›®é»‘é§…', note: 'æ±æ€¥æ±æ©«ç·š(15:31)â†’æ¾€è°·è»Šç«™(15:35)' },
                                { time: '16:20', type: 'spot', activity: 'SHIBUYA SKY', location: 'Shibuya Scramble Square', note: 'â˜… å‡ºç¤º QR Code å…¥å ´æ‹ç…§' },
                                { time: '18:00', type: 'food', activity: 'æ™šé¤', location: 'æ¾€è°·å‘¨é‚Š', note: '' },
                                { time: '21:00', type: 'transport', activity: 'è¿”å›æ°‘å®¿', location: 'æ¾€è°·é§…å‰', note: 'æ­ä¹˜å·´å£«(éƒ½06)â†’ä¸‰ä¹‹æ©‹(Sannohashi) (21:12-21:30)' }
                            ] 
                        },
                        { 
                            date: '12/09 (äºŒ)', shortDate: '12/09', fullDate: '2025-12-09', title: 'æœ€å¾Œæ¡è²·èˆ‡è¿”ç¨‹', 
                            flight: { type: 'departure', startTime: '17:15', startAirport: 'NRT', number: 'SL395', endTime: '20:20', endAirport: 'TPE', arrivalOffset: 0, note: '' },
                            items: [
                                 { time: '08:30', type: 'spot', activity: 'æ°‘å®¿ Check-out', location: 'æ°‘å®¿2', note: '' },
                                 { time: '08:44', type: 'transport', activity: 'å‰å¾€äº¬æˆä¸Šé‡', location: 'éº»å¸ƒåç•ªé§…', note: 'å—åŒ—ç·šâ†’æºœæ± å±±ç‹(08:48)â†’è½‰éŠ€åº§ç·šâ†’ä¸Šé‡å»£å°è·¯(09:08)' },
                                 { time: '09:10', type: 'shop', activity: 'é˜¿ç¾æ©«ç”ºä¼´æ‰‹ç¦® & ç¾è¡“é¤¨å·¡ç¦®', location: 'äº¬æˆä¸Šé‡é§…', note: 'å¯„æ”¾è¡Œæã€é€›é˜¿ç¾æ©«ç”ºã€ä¸Šé‡å…¬åœ’å»ºç¯‰' },
                                 { time: '12:00', type: 'food', activity: 'åˆé¤', location: 'ä¸Šé‡å‘¨é‚Š', note: '' },
                                 { time: '13:20', type: 'transport', activity: 'æ­ä¹˜ Skyliner å‰å¾€æ©Ÿå ´', location: 'äº¬æˆä¸Šé‡é§…', note: 'å»ºè­°æ­ä¹˜: 47è™Ÿ(13:20ç™¼) æˆ– 149è™Ÿ(13:37ç™¼)' },
                                 { time: '14:30', type: 'transport', activity: 'æ©Ÿå ´å ±åˆ° & æœ€å¾Œæ¡è²·', location: 'æˆç”°æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', note: 'SL395 (17:15èµ·é£›) -> TPE (20:20æŠµé”)' },
                                 { time: '21:13', type: 'transport', activity: 'æŠµé”å°ç£ & è¿”å®¶', location: 'æ¡ƒåœ’æ©Ÿå ´æ·é‹', note: 'ç›´é”è»Š(21:13-21:39)â†’æ–°åŒ—ç”¢æ¥­åœ’å€â†’è¨ˆç¨‹è»Š' }
                            ] 
                        }
                    ];
                    
                    // é è¨­åˆå§‹åŒ– (è‹¥æ²’æœ‰ LocalStorage è³‡æ–™æ™‚ä½¿ç”¨)
                    days.value = tokyoDataDays;
                    // ç‚ºäº†ç¢ºä¿é€™æ˜¯é è¨­è¡Œç¨‹ï¼Œä¹Ÿæ›´æ–° setup
                    setup.value.destination = 'Tokyo';
                    fetchWeather('Tokyo');

                    // 2. å•Ÿå‹• Firebase å³æ™‚ç›£è½
                    if (typeof initializeApp !== 'undefined' && typeof firebaseConfig !== 'undefined') {
                        try {
                            const app = initializeApp(firebaseConfig);
                            const db = getFirestore(app);
                            
                            // ä½¿ç”¨ tokyo_2025_final ä½œç‚ºå”¯ä¸€è³‡æ–™åº«è·¯å¾‘
                            if (tripRef) {
                                onSnapshot(tripRef, (docSnap) => {
                                    if (docSnap.exists()) {
                                        const data = docSnap.data();
                                        updatingFromRemote = true;
                                        days.value = data.days || days.value;
                                        expenses.value = data.expenses || expenses.value;
                                        if(data.exchangeRate) exchangeRate.value = data.exchangeRate;
                                        nextTick(() => { updatingFromRemote = false; });
                                        isOnline.value = true;
                                        isFirebaseReady.value = true; 
                                    } else {
                                        // é›²ç«¯ç„¡è³‡æ–™ (ç¬¬ä¸€æ¬¡)ï¼Œå°‡ä¸Šé¢çš„ Tokyo Data å¯«å…¥
                                        setDoc(tripRef, JSON.parse(JSON.stringify({
                                            days: days.value,
                                            expenses: expenses.value,
                                            exchangeRate: exchangeRate.value
                                        })));
                                        isOnline.value = true;
                                        isFirebaseReady.value = true; 
                                    }
                                });
                                // Watch & Upload
                                watch([days, expenses, exchangeRate, participantsStr], async () => {
                                    if (isFirebaseReady.value && !updatingFromRemote) { 
                                        try {
                                            await setDoc(tripRef, JSON.parse(JSON.stringify({
                                                days: days.value,
                                                expenses: expenses.value,
                                                exchangeRate: exchangeRate.value
                                            })));
                                        } catch (err) { console.error("Firebase Error", err); }
                                    }
                                }, { deep: true });
                            }
                        } catch (e) { console.log("Firebase Init Error", e); }
                    }

                    // LocalStorage Sync (ä½¿ç”¨ tokyo_2025_final key)
                    watch([days, expenses, exchangeRate, participantsStr, () => setup.value.destination, () => setup.value.currency, () => setup.value.langCode], () => {
                        localStorage.setItem('tokyo_2025_final_days', JSON.stringify(days.value));
                        localStorage.setItem('tokyo_2025_final_exp', JSON.stringify(expenses.value));
                        localStorage.setItem('tokyo_2025_final_rate', exchangeRate.value.toString());
                        localStorage.setItem('tokyo_2025_final_users', participantsStr.value);
                    }, { deep: true });
                });

                // Map & User Location Logic
                const initMap = async () => { 
                    isMapLoading.value = true; await nextTick(); if (!document.getElementById('map')) return;
                    if (mapInstance) { mapInstance.remove(); mapInstance = null; }
                    mapInstance = L.map('map').setView([35.6895, 139.6917], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(mapInstance);
                    if ("geolocation" in navigator) {
                         if (geoWatchId !== null) navigator.geolocation.clearWatch(geoWatchId);
                         geoWatchId = navigator.geolocation.watchPosition(pos => {
                             userLocation.value = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                             const icon = L.divIcon({ className: 'custom-div-icon', html: "<div class='gps-pulse'></div>", iconSize: [14, 14] });
                             if (userMarker) userMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
                             else userMarker = L.marker([pos.coords.latitude, pos.coords.longitude], { icon: icon }).addTo(mapInstance);
                         }, err => {}, { enableHighAccuracy: true });
                    }
                    const locs = currentDay.value.items.filter(i => i.location);
                    const bounds = L.latLngBounds();
                    for (const item of locs) {
                        try { await new Promise(r => setTimeout(r, 500)); const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}`); const d = await res.json(); if (d && d.length > 0) { const lat = parseFloat(d[0].lat); const lon = parseFloat(d[0].lon); L.marker([lat, lon]).addTo(mapInstance).bindPopup(`<b>${item.activity}</b><br>${item.location}`); bounds.extend([lat, lon]); } } catch (e) {}
                    }
                    isMapLoading.value = false; 
                    if(locs.length > 0) mapInstance.fitBounds(bounds, { padding: [50, 50] });
                };
                const centerOnUser = () => { if(userLocation.value && mapInstance) mapInstance.flyTo([userLocation.value.lat, userLocation.value.lng], 15); };
                watch(viewMode, (v) => { if(v === 'map') initMap(); });
                watch(currentDayIdx, () => { if(viewMode.value === 'map') initMap(); });

                return {
                    viewMode, currentDayIdx, days, currentDay, participants, participantsStr, updateParticipants,
                    getGoogleMapLink, addItem, removeItem, removeCurrentDay, addDay,
                    expenses, newExpense, totalExpense, addExpense, removeExpense,
                    paidByPerson, settlementPlan, exchangeRate,
                    isOnline, getTimePeriod, weather,
                    isMapLoading, userLocation, initMap, centerOnUser,
                    updateDate, showSetupModal, setup, initTrip, weatherDisplay, detectRate, isRateLoading, currencyLabel, currencySymbol, toggleFlightCard, getDotColor,
                    showTripMenu, tripList, createNewTrip, switchTrip, deleteTrip, currentTripId,
                    searchNearby, recommendationsMap, isSearchingRecs, applyRecommendation, searchTargetIndex
                };
            }
        }).mount('#app')
    </script>
</body>
</html>
