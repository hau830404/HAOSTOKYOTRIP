<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êù±‰∫¨ÂÜ¨ÊóÖ 2025 | Tokyo Trip</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Sans TC + JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons (ÂúñÁ§∫Â∫´) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS (Âú∞Âúñ) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS (Âú∞Âúñ) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif; background-color: #F3F4F6; }
        .jp-font { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Èö±Ëóè Scrollbar ‰ΩÜ‰øùÁïôÂäüËÉΩ */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* ÁéªÁíÉÊì¨ÊÖã */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* ËΩâÂ†¥ÂãïÁï´ */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        /* Âú∞ÂúñÂÆπÂô® */
        #map-container { z-index: 1; }
        
        /* ÂÆö‰ΩçÈªûÂëºÂê∏ÂãïÁï´ */
        .gps-pulse {
            width: 14px;
            height: 14px;
            border: 2px solid #fff;
            border-radius: 50%;
            background-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Ëá™Ë®Ç Popup Ê®£Âºè */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        .leaflet-container a { color: inherit; }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative sm:rounded-xl sm:my-4 sm:h-[95vh] sm:border-4 sm:border-slate-100">

        <!-- 1. Header & Êó•ÊúüÂ∞éËà™ -->
        <header class="bg-indigo-600 text-white shrink-0 z-20 shadow-md">
            <div class="p-4 flex justify-between items-center">
                <div class="mr-2">
                    <h1 class="text-xl font-bold tracking-wide flex items-center gap-2">
                        <i class="ph-fill ph-airplane-tilt"></i> Êù±‰∫¨ÂÜ¨ÊóÖ Tokyo
                    </h1>
                    <p class="text-xs text-indigo-200 mt-0.5 font-light tracking-wider">DEC 05 - DEC 09, 2025</p>
                </div>
                <!-- ÂäüËÉΩÂàáÊèõÊåâÈàïÂçÄ -->
                <div class="flex items-center gap-2 shrink-0">
                    
                    <!-- ÁøªË≠ØÂäüËÉΩÊåâÈàï -->
                    <button @click="viewMode = 'translate'" 
                            :class="viewMode === 'translate' ? 'bg-white text-indigo-700 shadow-sm' : 'bg-indigo-500/30 text-indigo-200 hover:bg-indigo-500/50'"
                            class="p-2.5 rounded-xl transition-all h-11 w-11 flex items-center justify-center border border-indigo-500/30">
                        <i class="ph-bold ph-translate text-xl"></i>
                    </button>

                    <!-- ÂéüÊúâÊóÖÈÅäÂäüËÉΩÁæ§ÁµÑ -->
                    <div class="flex bg-indigo-800/50 p-1 rounded-lg">
                        <button @click="viewMode = 'plan'" :class="viewMode === 'plan' ? 'bg-white text-indigo-700 shadow-sm' : 'text-indigo-200'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-calendar-check text-lg"></i></button>
                        <button @click="viewMode = 'map'" :class="viewMode === 'map' ? 'bg-white text-indigo-700 shadow-sm' : 'text-indigo-200'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-map-trifold text-lg"></i></button>
                        <button @click="viewMode = 'money'" :class="viewMode === 'money' ? 'bg-white text-indigo-700 shadow-sm' : 'text-indigo-200'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-currency-dollar text-lg"></i></button>
                    </div>
                </div>
            </div>

            <!-- Ê©´ÂêëÊó•ÊúüÈÅ∏ÊìáÂô® -->
            <div class="flex overflow-x-auto hide-scroll px-2 pb-3 space-x-3 snap-x">
                <div v-for="(day, index) in days" :key="index" 
                     @click="currentDayIdx = index"
                     class="snap-center shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-xl cursor-pointer transition-all border-2"
                     :class="currentDayIdx === index ? 'bg-white text-indigo-600 border-white shadow-lg scale-105' : 'bg-indigo-500/50 text-indigo-100 border-transparent hover:bg-indigo-500'">
                    <span class="text-xs font-medium opacity-80">{{ day.shortDate }}</span>
                    <span class="text-lg font-bold">D{{ index + 1 }}</span>
                </div>
                <!-- Êñ∞Â¢ûÂ§©Êï∏ÊåâÈàï -->
                <button @click="addDay" class="shrink-0 w-12 h-16 rounded-xl flex items-center justify-center border-2 border-indigo-400 border-dashed text-indigo-200 hover:text-white hover:border-white transition">
                    <i class="ph-bold ph-plus"></i>
                </button>
            </div>
        </header>

        <!-- 2. ‰∏ªË¶ÅÂÖßÂÆπÂçÄ (Êç≤ÂãïÂçÄ) -->
        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll">
            
            <!-- A. Ë°åÁ®ãË¶ñÂúñ (Plan View) -->
            <transition name="fade" mode="out-in">
                <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 pb-24">
                    
                    <!-- ÊØèÊó•Ê®ôÈ°åÂç°Áâá -->
                    <div class="bg-white p-4 rounded-2xl shadow-sm mb-6 border border-slate-100 flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 jp-font">{{ currentDay.date }}</h2>
                            <input v-model="currentDay.title" class="text-sm text-slate-500 bg-transparent border-b border-dashed border-slate-300 focus:border-indigo-500 focus:outline-none w-full mt-1" placeholder="Ëº∏ÂÖ•Áï∂Êó•‰∏ªÈ°å (‰æãÂ¶ÇÔºöÊ∑∫ËçâÊï£Á≠ñ)">
                        </div>
                        
                        <!-- Â§©Ê∞£È°ØÁ§∫ -->
                        <div class="flex flex-col items-end">
                            <div v-if="weather && weather.temp !== null" class="text-right">
                                <div class="flex items-center justify-end gap-2 text-indigo-600">
                                    <i :class="['ph-duotone', weather.icon, 'text-3xl']"></i>
                                    <span class="text-2xl font-bold font-mono">{{ weather.temp }}¬∞</span>
                                </div>
                                <div class="text-[10px] text-slate-400 mt-0.5 flex items-center gap-1 justify-end">
                                    <i class="ph-bold ph-map-pin"></i> Êù±‰∫¨ÁèæÂú®
                                </div>
                            </div>
                            <div v-else class="animate-pulse flex items-center gap-2">
                                <div class="w-8 h-8 bg-slate-200 rounded-full"></div>
                                <div class="w-8 h-4 bg-slate-200 rounded"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Ëà™Áè≠Ë≥áË®äÁâπÂà•Âç°Áâá (D1 & D5) -->
                    <div v-if="currentDayIdx === 0" class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-4 text-white shadow-lg mb-6 relative overflow-hidden">
                        <i class="ph-duotone ph-airplane-takeoff absolute -right-4 -bottom-4 text-9xl opacity-10"></i>
                        <div class="flex justify-between items-end mb-2">
                            <div class="text-center">
                                <div class="text-2xl font-bold">12:10</div>
                                <div class="text-xs opacity-80">TPE Âè∞Âåó</div>
                            </div>
                            <div class="flex flex-col items-center flex-1 px-4">
                                <span class="text-xs font-mono tracking-widest opacity-80">SL394</span>
                                <div class="w-full h-0.5 bg-white/30 relative my-1">
                                    <div class="absolute right-0 -top-1 w-2 h-2 bg-white rounded-full"></div>
                                </div>
                                <span class="text-xs text-green-300 font-bold">3h 05m</span>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">16:15</div>
                                <div class="text-xs opacity-80">NRT Êù±‰∫¨</div>
                            </div>
                        </div>
                        <div class="bg-white/10 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <i class="ph-fill ph-suitcase"></i> Ë®òÂæóÂ°´ÂØ´ Visit Japan Web
                        </div>
                    </div>

                    <div v-if="currentDayIdx === 4" class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-4 text-white shadow-lg mb-6 relative overflow-hidden">
                        <div class="flex justify-between items-end mb-2">
                            <div class="text-center">
                                <div class="text-2xl font-bold">17:15</div>
                                <div class="text-xs opacity-80">NRT Êù±‰∫¨</div>
                            </div>
                            <div class="flex flex-col items-center flex-1 px-4">
                                <span class="text-xs font-mono tracking-widest opacity-80">SL395</span>
                                <div class="w-full h-0.5 bg-white/30 relative my-1">
                                    <div class="absolute right-0 -top-1 w-2 h-2 bg-white rounded-full"></div>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">20:20</div>
                                <div class="text-xs opacity-80">TPE Âè∞Âåó</div>
                            </div>
                        </div>
                    </div>

                    <!-- ÊôÇÈñìËª∏Ë°åÁ®ãÂàóË°® -->
                    <div class="relative pl-4 border-l-2 border-indigo-100 space-y-8">
                        <div v-for="(item, idx) in currentDay.items" :key="idx" class="relative group">
                            <!-- Ë£ùÈ£æÂúìÈªû -->
                            <div class="absolute -left-[21px] top-3 w-3 h-3 rounded-full border-2 border-white shadow-sm"
                                 :class="item.type === 'food' ? 'bg-orange-400' : item.type === 'shop' ? 'bg-pink-400' : 'bg-indigo-500'"></div>
                            
                            <!-- ÂÖßÂÆπÂç°Áâá -->
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow group-hover:border-indigo-200">
                                <div class="flex flex-col gap-2">
                                    <!-- ‰∏äÂçäÈÉ®ÔºöËº∏ÂÖ•ÂçÄ -->
                                    <div class="flex items-start gap-3">
                                        <!-- ÊôÇÈñìËº∏ÂÖ• (UI ÂÑ™ÂåñÁâà) -->
                                        <div class="flex flex-col items-center w-20 shrink-0 gap-2">
                                            <!-- Ëá™Ë®ÇÊôÇÈñìÈ°ØÁ§∫Â°ä -->
                                            <div class="relative flex flex-col items-center justify-center bg-slate-50 border border-slate-200 rounded-xl p-1 w-full h-16 cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition group/time">
                                                <span class="text-[10px] font-medium text-slate-400 group-hover/time:text-indigo-400">{{ getTimePeriod(item.time) }}</span>
                                                <span class="text-xl font-bold text-slate-700 group-hover/time:text-indigo-600 leading-none font-mono tracking-tight">{{ item.time || '--:--' }}</span>
                                                <input v-model="item.time" type="time" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10">
                                            </div>

                                            <!-- È°ûÂûãÈÅ∏Êìá -->
                                            <select v-model="item.type" class="text-[10px] bg-white border border-slate-200 rounded-md py-1 px-1 w-full text-center text-slate-500 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="spot">üìç ÊôØÈªû</option>
                                                <option value="food">üç¥ ÁæéÈ£ü</option>
                                                <option value="shop">üõçÔ∏è Ë≥ºÁâ©</option>
                                                <option value="transport">üöá ‰∫§ÈÄö</option>
                                            </select>
                                        </div>

                                        <!-- ‰∏ªË¶ÅÂÖßÂÆπ -->
                                        <div class="flex-1 min-w-0 pt-1">
                                            <input v-model="item.activity" class="block w-full text-base font-bold text-slate-800 placeholder-slate-300 bg-transparent border-none p-0 focus:ring-0" placeholder="Ë°åÁ®ãÂêçÁ®±...">
                                            <div class="flex items-center gap-1 mt-1">
                                                <i class="ph-fill ph-map-pin text-indigo-400 text-xs shrink-0"></i>
                                                <input v-model="item.location" class="flex-1 text-xs text-slate-500 bg-transparent border-none p-0 focus:ring-0 placeholder-slate-300 truncate" placeholder="Ëº∏ÂÖ•Âú∞Èªû‰ª•Â∞éËà™">
                                            </div>
                                            <!-- ÂÇôË®ªÊ¨Ñ‰Ωç -->
                                            <div class="flex items-center gap-1 mt-1">
                                                <i class="ph-bold ph-info text-orange-400 text-xs shrink-0"></i>
                                                <input v-model="item.note" class="flex-1 text-xs text-orange-600/90 bg-transparent border-none p-0 focus:ring-0 placeholder-slate-200 truncate font-medium" placeholder="ÂÇôË®ª (‰æãÂ¶Ç: ÊèõÁ•®/ËΩâ‰πò)">
                                            </div>
                                        </div>

                                        <!-- Êìç‰ΩúÊåâÈàï -->
                                        <div class="flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity pt-1">
                                            <a :href="getGoogleMapLink(item.location)" target="_blank" class="text-indigo-500 hover:bg-indigo-50 p-1 rounded">
                                                <i class="ph-bold ph-navigation-arrow"></i>
                                            </a>
                                            <button @click="removeItem(idx)" class="text-red-300 hover:text-red-500 hover:bg-red-50 p-1 rounded">
                                                <i class="ph-bold ph-trash"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- ÁæéÈ£üÊé®Ëñ¶ÂçÄ (Áï∂È°ûÂûãÈÅ∏ÁæéÈ£üÊôÇÈ°ØÁ§∫) -->
                                    <div v-if="item.type === 'food'" class="p-2 bg-orange-50 rounded-lg border border-orange-100/50 mt-1">
                                        <p class="text-[10px] font-bold text-orange-400 mb-2 flex items-center gap-1">
                                            <i class="ph-fill ph-star"></i> Áï∂Êó•Êé®Ëñ¶ÁæéÈ£ü (ÁÑ°Áâõ/Êµ∑ÈÆÆ/Ë±¨Èõû) - ÈªûÊìäÂ°´ÂÖ•
                                        </p>
                                        <div class="flex flex-wrap gap-2">
                                            <button v-for="rec in (foodRecommendations[currentDayIdx] || [])" 
                                                    :key="rec.name"
                                                    @click="fillFood(item, rec)"
                                                    class="text-[10px] px-2 py-1.5 bg-white border border-orange-200 rounded-lg text-slate-600 hover:bg-orange-500 hover:text-white hover:border-orange-500 transition shadow-sm flex flex-col items-start gap-0.5">
                                                <span class="font-bold">{{ rec.name }}</span>
                                                <span class="text-[9px] opacity-70 scale-95 origin-left">{{ rec.category }}</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Êñ∞Â¢ûÊåâÈàï -->
                        <button @click="addItem" class="flex items-center gap-2 text-indigo-400 hover:text-indigo-600 text-sm font-medium px-2 py-1 transition-colors relative -left-1">
                            <div class="w-2 h-2 bg-indigo-300 rounded-full"></div>
                            <i class="ph-bold ph-plus"></i> Êñ∞Â¢ûË°åÁ®ã
                        </button>
                    </div>

                    <!-- Âà™Èô§Êï¥Â§©ÊåâÈàï -->
                    <div class="mt-12 pt-6 border-t border-slate-200 text-center">
                        <button @click="removeCurrentDay" class="text-xs text-red-300 hover:text-red-500 flex items-center justify-center gap-1 mx-auto">
                            <i class="ph-bold ph-trash"></i> Âà™Èô§ÈÄô‰∏ÄÂ§© (D{{currentDayIdx+1}})
                        </button>
                    </div>
                </div>
            </transition>

            <!-- B. Âú∞ÂúñË¶ñÂúñ (Map View) -->
            <div v-if="viewMode === 'map'" class="h-full flex flex-col relative">
                <!-- Âú∞ÂúñÊú¨È´î -->
                <div id="map" class="flex-1 w-full h-full bg-slate-200 z-0"></div>
                
                <!-- ËºâÂÖ•‰∏≠ÈÅÆÁΩ© -->
                <div v-if="isMapLoading" class="absolute inset-0 bg-white/50 backdrop-blur-sm z-10 flex flex-col items-center justify-center text-indigo-600">
                    <i class="ph-duotone ph-spinner animate-spin text-4xl mb-2"></i>
                    <span class="text-xs font-bold">Ê≠£Âú®ËÆÄÂèñÁï∂Êó•Ë°åÁ®ã‰ΩçÁΩÆ...</span>
                </div>

                <!-- Â∫ïÈÉ®Ë≥áË®äÂàó -->
                <div class="absolute bottom-4 left-4 right-4 bg-white/90 backdrop-blur rounded-xl p-3 shadow-lg border border-white/50 z-10 flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">CURRENT DAY MAP</div>
                        <div class="text-sm font-bold text-slate-800 flex items-center gap-1">
                            <i class="ph-fill ph-map-pin text-red-500"></i> {{ currentDay.items.filter(i=>i.location).length }} ÂÄãÂú∞Èªû
                            <span v-if="userLocation" class="ml-2 text-blue-600 flex items-center gap-1 text-xs"><i class="ph-fill ph-navigation-arrow"></i> Â∑≤ÂÆö‰Ωç</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <!-- 2. ÈáçÊñ∞Êï¥ÁêÜÊåâÈàï -->
                        <button @click="initMap" class="p-2 bg-indigo-100 text-indigo-600 rounded-lg hover:bg-indigo-200 transition" title="ÈáçÊñ∞ËÆÄÂèñÂú∞Âúñ">
                            <i class="ph-bold ph-arrows-clockwise"></i>
                        </button>
                        <!-- 1. Êñ∞Â¢ûÔºöÂÆö‰ΩçÊåâÈàï -->
                        <button @click="centerOnUser" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition shadow-md flex items-center gap-1" title="ÂõûÂà∞ÁõÆÂâç‰ΩçÁΩÆ">
                            <i class="ph-bold ph-crosshair"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- C. ÂàÜÂ∏≥Ë¶ñÂúñ (Money View) -->
            <div v-if="viewMode === 'money'" class="p-4 pb-24">
                <div class="bg-indigo-600 text-white rounded-2xl p-6 shadow-lg mb-6 text-center relative">
                    <!-- ÂåØÁéáË®≠ÂÆö -->
                    <div class="absolute top-4 right-4 flex flex-col items-end">
                        <label class="text-[10px] text-indigo-200 mb-1">ÂåØÁéá JPY‚ÜíTWD</label>
                        <input v-model.number="exchangeRate" type="number" step="0.001" class="w-16 text-right text-xs text-indigo-900 rounded px-1 py-0.5 border-none focus:ring-0 font-mono font-bold">
                    </div>

                    <div class="text-sm opacity-80 mb-1">Á∏ΩÊîØÂá∫ Total</div>
                    <div class="text-4xl font-bold font-mono">¬• {{ totalExpense.toLocaleString() }}</div>
                    <!-- Âè∞Âπ£ÊèõÁÆóÈ°ØÁ§∫ -->
                    <div class="text-lg font-bold text-indigo-200 mt-1">‚âà NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}</div>
                    
                    <div class="text-xs opacity-60 mt-2">Ôºà{{ participants.length }}‰∫∫ÂùáÂàÜÔºö¬• {{ (totalExpense / Math.max(1, participants.length)).toLocaleString(undefined, {maximumFractionDigits:0}) }}Ôºâ</div>
                </div>

                <!-- 1. Â¢ä‰ªòÁµ±Ë®à -->
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <div v-for="p in participants" :key="p" class="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                        <div class="text-xs text-slate-400 mb-1">{{ p }} Â¢ä‰ªò</div>
                        <div class="text-sm font-bold text-indigo-600">¬•{{ paidByPerson[p]?.toLocaleString() || 0 }}</div>
                        <div class="text-[10px] text-slate-400">‚âà NT$ {{ Math.round((paidByPerson[p] || 0) * exchangeRate).toLocaleString() }}</div>
                    </div>
                </div>

                <!-- 2. ÁµêÂ∏≥Âª∫Ë≠∞ -->
                <div v-if="settlementPlan.length > 0" class="bg-indigo-50 rounded-xl p-4 mb-6 border border-indigo-100">
                    <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wide mb-3 flex items-center gap-1">
                        <i class="ph-bold ph-scales"></i> ÁµêÂ∏≥Âª∫Ë≠∞ (Â§öÈÄÄÂ∞ëË£ú)
                    </h3>
                    <div class="space-y-2">
                        <div v-for="(plan, idx) in settlementPlan" :key="idx" class="flex items-center justify-between text-sm bg-white p-2 rounded-lg shadow-sm border border-indigo-50">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-600">{{ plan.from }}</span>
                                <i class="ph-bold ph-arrow-right text-indigo-300 text-xs"></i>
                                <span class="font-bold text-slate-600">{{ plan.to }}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-mono font-bold text-indigo-600">¬•{{ plan.amount.toLocaleString() }}</div>
                                <div class="text-[10px] text-slate-400 font-medium">‚âà NT$ {{ Math.round(plan.amount * exchangeRate).toLocaleString() }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Ë®òÂ∏≥Ëº∏ÂÖ• -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-500 mb-3 uppercase tracking-wide">Êñ∞Â¢ûÊ∂àË≤ª</h3>
                    <div class="flex gap-2 mb-2">
                        <input v-model="newExpense.item" placeholder="È†ÖÁõÆ (‰æã: ÁáíËÇâ)" class="flex-1 bg-slate-50 border-none rounded-lg text-sm px-3 py-2">
                        <select v-model="newExpense.payer" class="bg-slate-50 border-none rounded-lg text-sm px-2 py-2 w-20">
                            <option v-for="p in participants" :value="p">{{ p }}</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-2 text-slate-400">¬•</span>
                            <input v-model.number="newExpense.amount" type="number" placeholder="0" class="w-full bg-slate-50 border-none rounded-lg text-sm pl-7 pr-3 py-2 font-mono">
                        </div>
                        <button @click="addExpense" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold transition">
                            <i class="ph-bold ph-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- 4. Ê∏ÖÂñÆ -->
                <div class="space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 text-xs font-bold">
                                {{ exp.payer.charAt(0) }}
                            </div>
                            <div>
                                <div class="font-bold text-slate-700 text-sm">{{ exp.item }}</div>
                                <div class="text-xs text-slate-400">{{ exp.date || 'ÂâõÂâõ' }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-bold text-slate-700">¬•{{ exp.amount.toLocaleString() }}</span>
                            <button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400"><i class="ph-fill ph-x-circle"></i></button>
                        </div>
                    </div>
                </div>
            </div>

             <!-- D. ÁøªË≠ØË¶ñÂúñ (Translate View) - ÊîπÁâàÔºöÁõ¥Êé•ÈÄ£Áµê -->
             <div v-if="viewMode === 'translate'" class="p-6 h-full flex flex-col justify-center items-center pb-32">
                
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Google ÁøªË≠ØÊç∑Âæë</h2>
                    <p class="text-sm text-slate-400">ÈªûÊìä‰∏ãÊñπÊåâÈàïÔºåÁõ¥Êé•ÈñãÂïü Google ÁøªË≠ØÈ†ÅÈù¢</p>
                </div>

                <!-- ‰∏≠ÁøªÊó•ÂçÄÂ°ä -->
                <div class="w-full mb-6">
                    <a href="https://translate.google.com/?sl=zh-TW&tl=ja&op=translate" target="_blank" class="block w-full">
                        <button class="w-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left">
                                    <div class="text-xs opacity-80 mb-1 tracking-wider">ÊàëË™™‰∏≠Êñá (ËΩâÊó•Êñá)</div>
                                    <div class="text-2xl font-bold">CH <i class="ph-bold ph-arrow-right text-sm"></i> JP</div>
                                </div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl opacity-60 group-hover:opacity-100"></i>
                            </div>
                        </button>
                    </a>
                </div>

                <!-- Êó•Áøª‰∏≠ÂçÄÂ°ä -->
                <div class="w-full">
                    <a href="https://translate.google.com/?sl=ja&tl=zh-TW&op=translate" target="_blank" class="block w-full">
                        <button class="w-full bg-white border-2 border-slate-200 text-slate-700 rounded-2xl p-6 shadow-sm active:scale-95 transition-transform relative overflow-hidden group hover:border-indigo-300">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left">
                                    <div class="text-xs text-slate-400 mb-1 tracking-wider">Â∞çÊñπË™™Êó•Êñá (ËΩâ‰∏≠Êñá)</div>
                                    <div class="text-2xl font-bold font-jp">JP <i class="ph-bold ph-arrow-right text-sm"></i> CH</div>
                                </div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                            </div>
                        </button>
                    </a>
                </div>

            </div>

        </main>
        
        <!-- ÈÄ£Á∑öÁãÄÊÖãÊåáÁ§∫Ááà -->
        <div class="absolute top-1 right-1 z-50">
             <span v-if="isOnline" class="flex h-3 w-3 relative">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
            </span>
            <span v-else class="h-2 w-2 rounded-full bg-gray-300 inline-block m-1" title="ÂñÆÊ©üÊ®°Âºè"></span>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        
        // -------------------------------------------------------------
        // FIREBASE Ë®≠ÂÆöÂçÄ (Â∑≤Â°´ÂÖ•ÊÇ®ÁöÑÂ∞àÊ°àË≥áË®ä)
        // -------------------------------------------------------------
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwzTYCodPHbpwkvkIFRQ6-S1f3GP3LkX0",
            authDomain: "tokyotrip2025-c3a04.firebaseapp.com",
            projectId: "tokyotrip2025-c3a04",
            storageBucket: "tokyotrip2025-c3a04.firebasestorage.app",
            messagingSenderId: "382628977466",
            appId: "1:382628977466:web:048651923908a837074e03"
        };
        
        // ÂàùÂßãÂåñ Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // Ë®≠ÂÆöË≥áÊñôÂ∫´Êñá‰ª∂Ë∑ØÂæë (ÊâÄÊúâ‰∫∫ÈÉΩËÆÄÂèñÈÄô‰ªΩ 'tokyo_2025_v5' Êñá‰ª∂ÔºåÁ¢∫‰øùÊ∏ÖÁ©∫ËàäË≥áÊñô)
        const tripRef = doc(db, "trips", "tokyo_2025_v5"); 
        
        // -------------------------------------------------------------

        createApp({
            setup() {
                // UI ÁãÄÊÖã
                const viewMode = ref('plan'); // plan, map, money, translate
                const currentDayIdx = ref(0);
                const isOnline = ref(false); // Ê®ôÁ§∫ÊòØÂê¶ÈÄ£‰∏ä Firebase
                const isFirebaseReady = ref(false); // Êñ∞Â¢ûÔºöÁ¢∫‰øù‰∏ãËºâÂÆåÊàêÂæåÊâçÂÖÅË®±ÂØ´ÂÖ•
                const participants = ['Ë±™Ë±™', 'ÊüîÊüî']; // ÊàêÂì°ÂêçÂñÆ
                const exchangeRate = ref(0.215); // ÂåØÁéá JPY to TWD
                const isMapLoading = ref(false);
                const userLocation = ref(null);
                
                // Â§©Ê∞£ÁãÄÊÖã
                const weather = ref({ temp: null, icon: 'ph-sun', code: 0 });

                // ÁæéÈ£üÊé®Ëñ¶Ë≥áÊñô (ÁÑ°ÁâõÁâàÊú¨)
                const foodRecommendations = [
                    // Day 1
                    [
                        { name: 'Ê†πÂÆ§Ëä±‰∏∏Ëø¥ËΩâÂ£ΩÂè∏', location: 'Solamachi 6F', note: 'ÂåóÊµ∑ÈÅìÊñ∞ÈÆÆÊµ∑ÈÆÆÔºåÈúÄÊäΩËôüÁ¢ºÁâå', category: 'Â£ΩÂè∏' },
                        { name: 'ÂÖ≠ÂéòËàç', location: 'Solamachi 6F', note: 'ÊøÉÂéöË±öÈ™®È≠ö‰ªãÊ≤æÈ∫µ', category: 'ÊãâÈ∫µ' },
                        { name: 'Áü¢Â†¥Âë≥ÂôåË±¨Êéí', location: 'Solamachi 6F', note: 'ÂêçÂè§Â±ãÁ¥ÖÂë≥ÂôåÁÇ∏Ë±¨Êéí', category: 'Ë±¨Êéí' }
                    ],
                    // Day 2
                    [
                        { name: 'ÊñëÈ≥© (Ikaruga)', location: 'Êù±‰∫¨ËªäÁ´ô‰∏ÄÁï™Ë°ó B1', note: 'Ë±öÈ™®È≠ö‰ªãÊπØÈ†≠ÊãâÈ∫µ', category: 'ÊãâÈ∫µ' },
                        { name: 'Á©∫‰πãËâ≤ NIPPON', location: 'Êù±‰∫¨ËªäÁ´ô‰∏ÄÁï™Ë°ó B1', note: 'Ê∏ÖÁàΩËî¨ËèúÊãâÈ∫µ(ÊúâÁ¥†È£ü)', category: 'ÊãâÈ∫µ' },
                        { name: 'Tsurutontan', location: 'Êù±ÊÄ• Plaza ÈäÄÂ∫ß', note: 'Â§ßÁ¢óÂÖ¨ÂâµÊÑèÁÉèÈæçÈ∫µ', category: 'ÁÉèÈæçÈ∫µ' }
                    ],
                    // Day 3
                    [
                        { name: '‰∏¶Êú®Ëó™ËïéÈ∫•', location: 'Ê∑∫Ëçâ', note: 'ÁôæÂπ¥ËÄÅÂ∫óÔºåÈ¥®ÂçóËõÆÂøÖÈªû', category: 'ËïéÈ∫•È∫µ' },
                        { name: 'Â§ßÈªëÂÆ∂Â§©Â©¶ÁæÖ', location: 'Ê∑∫Ëçâ', note: 'È∫ªÊ≤πÈªëÈÜ¨Ê±ÅÂ§©‰∏º', category: 'Â§©‰∏º' },
                        { name: 'Ê∑∫ËçâÊñáÂ≠óÁáí ÈπøÈáé', location: 'Ê∑∫Ëçâ', note: 'ÊòéÂ§™Â≠êÊñáÂ≠óÁáí', category: 'ÊñáÂ≠óÁáí' },
                        { name: 'Unana', location: 'Ê∑∫Ëçâ', note: 'È∞ªÈ≠öÁÉ§È£ØÁ≥∞', category: 'Â∞èÂêÉ' },
                        { name: 'Á∏ΩÊú¨ÂÆ∂ Êõ¥ÁßëÂ†Ä‰∫ï', location: 'È∫ªÂ∏ÉÂçÅÁï™', note: 'ÁöáÂÆ§Âæ°Áî®ËïéÈ∫•È∫µ', category: 'ËïéÈ∫•È∫µ' },
                        { name: 'AFURI (ÈòøÂ§´Âà©)', location: 'ÂÖ≠Êú¨Êú®/È∫ªÂ∏ÉÂçÅÁï™', note: 'ÊüöÂ≠êÈπΩÊãâÈ∫µ (ÈõûÊπØÂ∫ï)', category: 'ÊãâÈ∫µ' },
                        { name: 'Savoy', location: 'È∫ªÂ∏ÉÂçÅÁï™', note: 'ÂÇ≥Ë™™‰∏≠ÁöÑÁ™ØÁÉ§Êä´Ëñ©', category: 'Êä´Ëñ©' }
                    ],
                    // Day 4
                    [
                        { name: 'Seirinkan (ËÅñÊûóÈ§®)', location: '‰∏≠ÁõÆÈªë', note: 'Á∂ìÂÖ∏Áë™Ê†ºÈ∫óÁâπÊä´Ëñ©', category: 'Êä´Ëñ©' },
                        { name: 'ÈõûËÇâÊñôÁêÜ Hashidaya', location: '‰∏≠ÁõÆÈªë', note: 'ÊªëÂ´©Ë¶™Â≠ê‰∏º', category: 'Ë¶™Â≠ê‰∏º' },
                        { name: 'I\'m Donut?', location: '‰∏≠ÁõÆÈªë/ÊæÄË∞∑', note: 'ÁîüÁîúÁîúÂúà', category: 'ÁîúÈªû' },
                        { name: 'ÁëûÂÖÜ', location: 'ÊæÄË∞∑', note: 'Á¨¨‰∏ÄÂêçÁÇ∏Ë±¨ÊéíËìãÈ£Ø', category: 'Ë±¨Êéí‰∏º' },
                        { name: 'È≥•Á´π', location: 'ÊæÄË∞∑', note: 'ËÄÅÂ≠óËôüÁáíÈ≥•Â±ÖÈÖíÂ±ã', category: '‰∏≤Ááí' },
                        { name: 'Uobei Sushi', location: 'ÊæÄË∞∑', note: 'È´òÈÄüËªåÈÅìÂπ≥ÂÉπÂ£ΩÂè∏', category: 'Â£ΩÂè∏' }
                    ],
                    // Day 5
                    [
                        { name: 'Âêç‰ª£ ÂÆáÂ•à„Å®„Å®', location: '‰∏äÈáé', note: 'Âπ≥ÂÉπÈ∞ªÈ≠öÈ£Ø', category: 'È∞ªÈ≠ö' },
                        { name: 'Â±±ÂÆ∂ÁÇ∏Ë±¨Êéí', location: '‰∏äÈáé', note: 'È´òCPÂÄºÂéöÂàáË±¨Êéí', category: 'Ë±¨Êéí' },
                        { name: 'ÊπäÂ±ãÈ£üÂìÅ', location: '‰∏äÈáéÈòøÁæéÊ©´Áî∫', note: 'Êµ∑ÈÆÆ‰∏º„ÄÅÁ´†È≠öÁáí', category: 'Êµ∑ÈÆÆ' }
                    ]
                ];

                // Ë≥áÊñôÁµêÊßã
                const days = ref([
                    { 
                        date: '12/05 (‰∫î)', shortDate: '12/05', title: 'ÊäµÈÅîÊù±‰∫¨ & Ê∞ëÂÆø Check-in', 
                        items: [
                            { time: '08:30', type: 'transport', activity: 'ÂâçÂæÄÊ©üÂ†¥ (Ë®àÁ®ãËªä+Ê©üÊç∑)', location: 'Êñ∞ÂåóÁî¢Ê•≠ÂúíÂçÄÁ´ô', note: 'Ë®àÁ®ãËªäËá≥Ê©üÊç∑Á´ôÔºåÊê≠‰πòÁõ¥ÈÅîËªä(08:55-09:21)Ëá≥Ê°ÉÊ©üT1' },
                            { time: '09:30', type: 'transport', activity: 'Ê©üÂ†¥ Check-in', location: 'Ê°ÉÂúíÊ©üÂ†¥Á¨¨‰∏ÄËà™Âªà', note: 'SL394 (12:10Ëµ∑È£õ)' },
                            { time: '16:15', type: 'transport', activity: 'ÊäµÈÅîÊàêÁî∞Ê©üÂ†¥ T1 (SL394)', location: 'ÊàêÁî∞Ê©üÂ†¥Á¨¨‰∏ÄËà™Âªà', note: '' },
                            { time: '16:45', type: 'transport', activity: 'B1 ÊóÖÈÅäÊúçÂãô‰∏≠ÂøÉÂÖåÊèõ Skyliner', location: 'Skyliner & Keisei Information Center', note: 'ÂÖåÊèõ‰æÜÂõûÁ•®(ÂõûÁ®ãÂà∏‰øùÁïô)ÔºåÊê≠154Ê¨°ÂæÄÈùíÁ†•' },
                            { time: '17:19', type: 'transport', activity: 'Skyliner 154Ê¨° ÁôºËªä', location: 'ÊàêÁî∞Á©∫Ê∏ØÈßÖ', note: '17:53 ÊäµÈÅîÈùíÁ†•Á´ô' },
                            { time: '17:59', type: 'transport', activity: 'ÈùíÁ†•Á´ôËΩâ‰πò (‰∫¨ÊàêÊäº‰∏äÁ∑ö)', location: 'ÈùíÁ†•ÈßÖ', note: 'ÂæÄÊäº‰∏äÊñπÂêëÊôÆÈÄöËªäÔºå18:05 ÊäµÈÅî‰∫¨ÊàêÊõ≥Ëàü' },
                            { time: '18:15', type: 'spot', activity: 'Ê∞ëÂÆø Check-in (Âá∫Á´ôÂà∑Ë•øÁìúÂç°)', location: '2-ch≈çme-30-9 Higashimuk≈çjima, Sumida City', note: '' },
                            { time: '19:00', type: 'food', activity: 'ÊôöÈ§ê', location: 'Êäº‰∏äÂë®ÈÇä', note: '' },
                            { time: '19:30', type: 'spot', activity: 'Êù±‰∫¨Êô¥Á©∫Â°î & ËÅñË™ïÂ∏ÇÈõÜ', location: 'Êù±‰∫¨Êô¥Á©∫Â°î', note: '‚òÖ ÂãôÂøÖÂú®Ê≠§(Êäº‰∏äÁ´ô)ÂÖåÊèõÊù±‰∫¨Âú∞Èêµ‰∏âÊó•Âà∏' }
                        ] 
                    },
                    { 
                        date: '12/06 (ÂÖ≠)', shortDate: '12/06', title: 'ÂØåÂ£´Â±±‰∏ÄÊó•ÈÅä & Êù±‰∫¨ËªäÁ´ôÂ§úÊôØ', 
                        items: [
                            { time: '05:53', type: 'transport', activity: 'ÂâçÂæÄÊúâÊ®ÇÁî∫/Êó•ÊØîË∞∑', location: '‰∫¨ÊàêÊõ≥ËàüÈßÖ', note: 'Êù±Ê≠¶Êô¥Á©∫Â°îÁ∑ö(5:57)‚ÜíÂ§ßÊâãÁî∫‚Üí‰∏âÁî∞Á∑ö(6:24)‚ÜíÊó•ÊØîË∞∑ (ÂèØÁî®ÈÄöÁ•®)' },
                            { time: '06:30', type: 'spot', activity: 'Ë≥ûÈäÄÊùè & Ê≠•Ë°åËá≥ÈõÜÂêàÈªû', location: 'Êó•ÊØîË∞∑ÂÖ¨Âúí', note: 'Êï£Ê≠•Ëá≥Êù±‰∫¨ËªäÁ´ô‰∏∏‰πãÂÖßÂ§ßÂªà' },
                            { time: '07:15', type: 'spot', activity: 'ÂØåÂ£´Â±±‰∏ÄÊó•ÈÅä (ÈõÜÂêà)', location: '‰∏∏‰πãÂÖßÂ§ßÂªà', note: '‚òÖ 07:20Ââç ‰∏ÄÊ®ìÈõÜÂêàÂÆåÁï¢' },
                            { time: '18:00', type: 'food', activity: 'ÊôöÈ§ê & ËÅñË™ïÂ∏ÇÈõÜ', location: 'Êù±‰∫¨ËªäÁ´ô', note: '‰∏∏‰πãÂÖß‰ª≤ÈÄöÂª∫ÁØâÂªäÈÅì„ÄÅÂ§ßÂªàÂ§úÊôØ' },
                            { time: '21:00', type: 'transport', activity: 'ËøîÂõûÊ∞ëÂÆø', location: 'ÂØ∂Áî∫ÈßÖ', note: 'Ê∑∫ËçâÁ∑ö(21:10)‚Üí‰∫¨ÊàêÊõ≥Ëàü(21:27) (ÂèØÁî®ÈÄöÁ•®ÔºåÂá∫Á´ôÂà∑Ë•øÁìúÂç°Ë£úÁ•®)' }
                        ] 
                    },
                    { 
                        date: '12/07 (Êó•)', shortDate: '12/07', title: 'Ê∑∫ËçâÊñáÂåñ & ÂÖ≠Êú¨Êú®ËóùË°ìÂ∑°Á¶Æ', 
                        items: [
                            { time: '08:18', type: 'transport', activity: 'ÂâçÂæÄÊ∑∫Ëçâ', location: 'Êõ≥ËàüÈßÖ', note: 'Êù±Ê≠¶Êô¥Á©∫Â°îÁ∑ö(8:18)‚ÜíÊ∑∫Ëçâ(8:24)' },
                            { time: '08:30', type: 'spot', activity: 'Ê∑∫ËçâÂØ∫ & Èõ∑ÈñÄ', location: 'Ê∑∫ËçâÂØ∫', note: '‰ª≤Ë¶ã‰∏ñÂïÜÂ∫óË°óÈÄõË°ó' },
                            { time: '12:00', type: 'food', activity: 'ÂçàÈ§ê', location: 'Ê∑∫ËçâÂë®ÈÇä', note: '' },
                            { time: '13:00', type: 'transport', activity: 'ÂâçÂæÄÂÖ≠Êú¨Êú® (ÊîæË°åÊùé)', location: 'Ê∑∫ËçâÈßÖ', note: 'ÈäÄÂ∫ßÁ∑ö‚ÜíÈäÄÂ∫ß(13:23)‚ÜíËΩâÊó•ÊØîË∞∑Á∑ö‚ÜíÂÖ≠Êú¨Êú®(13:37) (ÂèØÁî®ÈÄöÁ•®)' },
                            { time: '13:30', type: 'spot', activity: 'ÂÖ≠Êú¨Êú®ËóùË°ìÊï£Á≠ñ', location: 'ÂÖ≠Êú¨Êú®Ëî¶Â±ãÊõ∏Â∫ó', note: 'ÊãçÊù±‰∫¨ÈêµÂ°î„ÄÅÊ£ÆÁæéË°ìÈ§®„ÄÅ21_21„ÄÅÂúãÁ´ãÊñ∞ÁæéË°ìÈ§®' },
                            { time: '15:35', type: 'transport', activity: 'ÂâçÂæÄÊ∞ëÂÆø2', location: 'ÂÖ≠Êú¨Êú®ÈßÖÂâç', note: 'Êê≠‰πòÂ∑¥Â£´(Âèç96)‚Üí‰∏â‰πãÊ©ã(Sannohashi) (15:37-15:48)' },
                            { time: '16:00', type: 'spot', activity: 'Ê∞ëÂÆø2 Check-in', location: '2-ch≈çme-2-18 Minamiazabu, Minato City', note: 'ËøëÈ∫ªÂ∏ÉÂçÅÁï™/‰∏âÁî∞Á´ô' },
                            { time: '17:30', type: 'food', activity: 'ÊôöÈ§ê', location: 'È∫ªÂ∏ÉÂçÅÁï™/ÂÖ≠Êú¨Êú®', note: '' },
                            { time: '18:30', type: 'spot', activity: 'Ë°®ÂèÉÈÅì & ÂéüÂÆøÈÄõË°ó', location: 'Ë°®ÂèÉÈÅì', note: 'Spiral(Ëá≥19:00)„ÄÅËóçÁì∂ÈùíÂ±±(Ëá≥19:00)„ÄÅÊ†πÊ¥•ÁæéË°ìÈ§®(Â∑≤ÈóúÈñÄ)' },
                            { time: '21:00', type: 'transport', activity: 'ËøîÂõûÊ∞ëÂÆø', location: 'ÊòéÊ≤ªÁ•ûÂÆÆÂâç„ÄàÂéüÂÆø„ÄâÈßÖ', note: 'ÂçÉ‰ª£Áî∞Á∑ö(21:05)‚ÜíÂúãÊúÉË≠∞‰∫ãÂ†ÇÂâç‚ÜíËΩâÂçóÂåóÁ∑ö‚ÜíÈ∫ªÂ∏ÉÂçÅÁï™(21:20)' }
                        ]
                    },
                    { 
                        date: '12/08 (‰∏Ä)', shortDate: '12/08', title: '‰ª£ÂÆòÂ±±Êó©ÂçàÈ§ê & ÊæÄË∞∑Â§©ÈöõÁ∑ö', 
                        items: [
                            { time: '08:30', type: 'transport', activity: 'ÂâçÂæÄ‰ª£ÂÆòÂ±±', location: '‰∏â‰πãÊ©ã(Sannohashi)ÂÖ¨ËªäÁ´ô', note: 'Êê≠‰πòÂ∑¥Â£´(ÈÉΩ06)‚ÜíÊù±‰∏â‰∏ÅÁõÆ(Higashi 3) (08:37-08:51)' },
                            { time: '09:00', type: 'food', activity: 'Ivy Place Êó©È§ê', location: '16-15 Sarugakuch≈ç, Shibuya', note: '‚òÖ Klook Â∑≤Ë®Ç‰Ωç' },
                            { time: '12:00', type: 'spot', activity: '‰∏≠ÁõÆÈªëÊï£Á≠ñ', location: '‰∏≠ÁõÆÈªë', note: 'ÈÄõË°óË≥ºÁâ©' },
                            { time: '13:00', type: 'food', activity: 'ÂçàÈ§ê', location: '‰∏≠ÁõÆÈªëÂë®ÈÇä', note: '' },
                            { time: '15:30', type: 'transport', activity: 'ÂâçÂæÄÊæÄË∞∑', location: '‰∏≠ÁõÆÈªëÈßÖ', note: 'Êù±ÊÄ•Êù±Ê©´Á∑ö(15:31)‚ÜíÊæÄË∞∑ËªäÁ´ô(15:35)' },
                            { time: '16:20', type: 'spot', activity: 'SHIBUYA SKY', location: 'Shibuya Scramble Square', note: '‚òÖ Âá∫Á§∫ QR Code ÂÖ•Â†¥ÊãçÁÖß' },
                            { time: '18:00', type: 'food', activity: 'ÊôöÈ§ê', location: 'ÊæÄË∞∑Âë®ÈÇä', note: '' },
                            { time: '21:00', type: 'transport', activity: 'ËøîÂõûÊ∞ëÂÆø', location: 'ÊæÄË∞∑ÈßÖÂâç', note: 'Êê≠‰πòÂ∑¥Â£´(ÈÉΩ06)‚Üí‰∏â‰πãÊ©ã(Sannohashi) (21:12-21:30)' }
                        ] 
                    },
                    { 
                        date: '12/09 (‰∫å)', shortDate: '12/09', title: 'ÊúÄÂæåÊé°Ë≤∑ËàáËøîÁ®ã', 
                        items: [
                             { time: '08:30', type: 'spot', activity: 'Ê∞ëÂÆø Check-out', location: 'Ê∞ëÂÆø2', note: '' },
                             { time: '08:44', type: 'transport', activity: 'ÂâçÂæÄ‰∫¨Êàê‰∏äÈáé', location: 'È∫ªÂ∏ÉÂçÅÁï™ÈßÖ', note: 'ÂçóÂåóÁ∑ö‚ÜíÊ∫úÊ±†Â±±Áéã(08:48)‚ÜíËΩâÈäÄÂ∫ßÁ∑ö‚Üí‰∏äÈáéÂª£Â∞èË∑Ø(09:08)' },
                             { time: '09:10', type: 'shop', activity: 'ÈòøÁæéÊ©´Áî∫‰º¥ÊâãÁ¶Æ & ÁæéË°ìÈ§®Â∑°Á¶Æ', location: '‰∫¨Êàê‰∏äÈáéÈßÖ', note: 'ÂØÑÊîæË°åÊùé„ÄÅÈÄõÈòøÁæéÊ©´Áî∫„ÄÅ‰∏äÈáéÂÖ¨ÂúíÂª∫ÁØâ' },
                             { time: '12:00', type: 'food', activity: 'ÂçàÈ§ê', location: '‰∏äÈáéÂë®ÈÇä', note: '' },
                             { time: '13:20', type: 'transport', activity: 'Êê≠‰πò Skyliner ÂâçÂæÄÊ©üÂ†¥', location: '‰∫¨Êàê‰∏äÈáéÈßÖ', note: 'Âª∫Ë≠∞Êê≠‰πò: 47Ëôü(13:20Áôº) Êàñ 149Ëôü(13:37Áôº)' },
                             { time: '14:30', type: 'transport', activity: 'Ê©üÂ†¥Â†±Âà∞ & ÊúÄÂæåÊé°Ë≤∑', location: 'ÊàêÁî∞Ê©üÂ†¥Á¨¨‰∏ÄËà™Âªà', note: 'SL395 (17:15Ëµ∑È£õ) -> TPE (20:20ÊäµÈÅî)' },
                             { time: '21:13', type: 'transport', activity: 'ÊäµÈÅîÂè∞ÁÅ£ & ËøîÂÆ∂', location: 'Ê°ÉÂúíÊ©üÂ†¥Êç∑ÈÅã', note: 'Áõ¥ÈÅîËªä(21:13-21:39)‚ÜíÊñ∞ÂåóÁî¢Ê•≠ÂúíÂçÄ‚ÜíË®àÁ®ãËªä' }
                        ] 
                    }
                ]);

                const expenses = ref([]);
                const newExpense = ref({ item: '', amount: '', payer: 'Ë±™Ë±™' });

                // Ë®àÁÆóÂ±¨ÊÄß
                const currentDay = computed(() => days.value[currentDayIdx.value]);
                
                const totalExpense = computed(() => {
                    return expenses.value.reduce((sum, item) => sum + item.amount, 0);
                });

                // ÂàÜÂ∏≥ÈÇèËºØ
                const paidByPerson = computed(() => {
                    const map = {};
                    participants.forEach(p => map[p] = 0);
                    expenses.value.forEach(e => {
                        if (map[e.payer] === undefined) map[e.payer] = 0;
                        map[e.payer] += e.amount;
                    });
                    return map;
                });

                const settlementPlan = computed(() => {
                    if (totalExpense.value === 0) return [];
                    const average = totalExpense.value / participants.length;
                    let balances = participants.map(p => ({
                        name: p,
                        val: (paidByPerson.value[p] || 0) - average
                    }));
                    let debtors = balances.filter(b => b.val < -1).sort((a, b) => a.val - b.val);
                    let creditors = balances.filter(b => b.val > 1).sort((a, b) => b.val - a.val);
                    const result = [];
                    let i = 0; 
                    let j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let debtor = debtors[i];
                        let creditor = creditors[j];
                        let amount = Math.min(Math.abs(debtor.val), creditor.val);
                        amount = Math.round(amount);
                        if (amount > 0) {
                            result.push({ from: debtor.name, to: creditor.name, amount: amount });
                        }
                        debtor.val += amount;
                        creditor.val -= amount;
                        if (Math.abs(debtor.val) < 1) i++;
                        if (creditor.val < 1) j++;
                    }
                    return result;
                });

                // ÊñπÊ≥ï
                const addItem = () => {
                    currentDay.value.items.push({ time: '', type: 'spot', activity: '', location: '' });
                };

                const removeItem = (idx) => {
                    currentDay.value.items.splice(idx, 1);
                };

                const removeCurrentDay = () => {
                    if(confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÊï¥Â§©ÁöÑË°åÁ®ãÔºü')) {
                        days.value.splice(currentDayIdx.value, 1);
                        if(currentDayIdx.value >= days.value.length) currentDayIdx.value = Math.max(0, days.value.length - 1);
                    }
                };

                const addDay = () => {
                    days.value.push({ date: 'Êñ∞ÁöÑ‰∏ÄÂ§©', shortDate: 'Day+', title: '', items: [] });
                };

                const getGoogleMapLink = (loc) => {
                    if(!loc) return '#';
                    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;
                };

                const addExpense = () => {
                    if(!newExpense.value.item || !newExpense.value.amount) return;
                    expenses.value.unshift({ ...newExpense.value, date: new Date().toLocaleDateString() });
                    newExpense.value.item = '';
                    newExpense.value.amount = '';
                };

                const removeExpense = (idx) => {
                    expenses.value.splice(idx, 1);
                };

                const getTimePeriod = (timeStr) => {
                    if (!timeStr) return 'Ë®≠ÂÆö';
                    const hour = parseInt(timeStr.split(':')[0], 10);
                    if (hour < 5) return 'ÂáåÊô®';
                    if (hour < 11) return '‰∏äÂçà';
                    if (hour >= 11 && hour < 14) return '‰∏≠Âçà';
                    if (hour >= 14 && hour < 18) return '‰∏ãÂçà';
                    return 'Êôö‰∏ä';
                };

                const fillFood = (item, rec) => {
                    item.activity = rec.name;
                    item.location = rec.location;
                    item.note = rec.note;
                };

                // ÂèñÂæóÊù±‰∫¨Â§©Ê∞£ (Open-Meteo API)
                const fetchTokyoWeather = async () => {
                    try {
                        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current_weather=true&timezone=Asia%2FTokyo');
                        const data = await res.json();
                        const w = data.current_weather;
                        weather.value.temp = Math.round(w.temperature);
                        const c = w.weathercode;
                        if (c === 0) weather.value.icon = 'ph-sun';
                        else if (c >= 1 && c <= 3) weather.value.icon = 'ph-cloud-sun';
                        else if (c >= 45 && c <= 48) weather.value.icon = 'ph-cloud-fog';
                        else if (c >= 51 && c <= 67) weather.value.icon = 'ph-cloud-rain';
                        else if (c >= 71 && c <= 77) weather.value.icon = 'ph-snowflake';
                        else if (c >= 80 && c <= 82) weather.value.icon = 'ph-cloud-rain';
                        else if (c >= 95) weather.value.icon = 'ph-cloud-lightning';
                        else weather.value.icon = 'ph-cloud';
                    } catch (e) {
                        console.error("Â§©Ê∞£Áç≤ÂèñÂ§±Êïó", e);
                        weather.value.temp = '--';
                    }
                };

                // --- Âú∞ÂúñÁõ∏ÈóúÂäüËÉΩ (Leaflet) ---
                let mapInstance = null;
                let userMarker = null;
                let dayMarkers = [];

                const initMap = async () => {
                    isMapLoading.value = true;
                    
                    // Á≠âÂæÖ DOM Êõ¥Êñ∞Á¢∫‰øù #map Â≠òÂú®
                    await nextTick();
                    
                    if (!document.getElementById('map')) return;

                    // Ëã•Âú∞ÂúñÂ∑≤Â≠òÂú®ÔºåÂÖàÁßªÈô§
                    if (mapInstance) {
                        mapInstance.remove();
                        mapInstance = null;
                    }

                    // ÂàùÂßãÂåñÂú∞Âúñ (È†êË®≠Êù±‰∫¨)
                    mapInstance = L.map('map').setView([35.6895, 139.6917], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap'
                    }).addTo(mapInstance);

                    // 1. ÂÆö‰Ωç‰ΩøÁî®ËÄÖ
                    if ("geolocation" in navigator) {
                        navigator.geolocation.watchPosition(
                            (position) => {
                                const { latitude, longitude } = position.coords;
                                userLocation.value = { lat: latitude, lng: longitude };
                                
                                // Ëá™Ë®ÇËóçËâ≤ÂúìÈªû Icon
                                const userIcon = L.divIcon({
                                    className: 'custom-div-icon',
                                    html: "<div class='gps-pulse'></div>",
                                    iconSize: [14, 14],
                                    iconAnchor: [7, 7]
                                });

                                if (userMarker) {
                                    userMarker.setLatLng([latitude, longitude]);
                                } else {
                                    userMarker = L.marker([latitude, longitude], { icon: userIcon }).addTo(mapInstance);
                                    userMarker.bindPopup("ÊÇ®Âú®ÈÄôË£°").openPopup();
                                }
                            },
                            (err) => console.log("ÂÆö‰ΩçÂ§±Êïó", err),
                            { enableHighAccuracy: true }
                        );
                    }

                    // 2. Ê®ôË®òÁï∂Â§©Ë°åÁ®ã
                    dayMarkers = [];
                    const locations = currentDay.value.items.filter(i => i.location && i.location.trim() !== '');
                    
                    if (locations.length === 0) {
                        isMapLoading.value = false;
                        return;
                    }

                    // ÊâπÊ¨°Êü•Ë©¢Â∫ßÊ®ô (Nominatim)
                    const bounds = L.latLngBounds();
                    let validPoints = 0;

                    for (const item of locations) {
                        try {
                            // Âª∂ÈÅ≤‰ª•ÈÅøÂÖçÂ§™Âø´ÊíûÂà∞ API ÈôêÂà∂
                            await new Promise(r => setTimeout(r, 600)); 
                            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}`);
                            const data = await res.json();
                            
                            if (data && data.length > 0) {
                                const lat = parseFloat(data[0].lat);
                                const lon = parseFloat(data[0].lon);
                                const marker = L.marker([lat, lon]).addTo(mapInstance);
                                
                                // Â∞éËà™ÈÄ£Áµê
                                const googleMapsLink = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
                                
                                marker.bindPopup(`
                                    <div class="text-center p-2">
                                        <b class="text-sm block mb-1">${item.activity}</b>
                                        <span class="text-xs text-gray-500 block mb-2">${item.location}</span>
                                        <a href="${googleMapsLink}" target="_blank" class="inline-flex items-center gap-1 bg-blue-500 text-white px-3 py-1.5 rounded-full text-xs font-bold hover:bg-blue-600 transition no-underline">
                                            <i class="ph-bold ph-navigation-arrow"></i> Google Â∞éËà™
                                        </a>
                                    </div>
                                `);
                                dayMarkers.push(marker);
                                bounds.extend([lat, lon]);
                                validPoints++;
                            }
                        } catch (e) {
                            console.log(`ÁÑ°Ê≥ïÊâæÂà∞Â∫ßÊ®ô: ${item.location}`);
                        }
                    }

                    isMapLoading.value = false;
                    
                    // Ëá™ÂãïÁ∏ÆÊîæË¶ñÈáé
                    if (validPoints > 0) {
                        mapInstance.fitBounds(bounds, { padding: [50, 50] });
                    }
                };

                // ÂÆö‰ΩçÂäüËÉΩÔºöÂõûÂà∞‰ΩøÁî®ËÄÖ‰ΩçÁΩÆ
                const centerOnUser = () => {
                    if (userLocation.value && mapInstance) {
                        mapInstance.flyTo([userLocation.value.lat, userLocation.value.lng], 15);
                        if (userMarker) {
                            userMarker.openPopup();
                        }
                    } else {
                        alert("Â∞öÊú™ÂèñÂæóÊÇ®ÁöÑ‰ΩçÁΩÆË≥áË®äÔºåË´ãÁ¢∫Ë™çÁÄèË¶ΩÂô®Â∑≤ÊéàÊ¨äÂÆö‰ΩçÂäüËÉΩ„ÄÇ");
                    }
                };

                // Áõ£ËÅΩ viewMode ÂàáÊèõÂà∞ map ÊôÇÂàùÂßãÂåñ
                watch(viewMode, (newVal) => {
                    if (newVal === 'map') {
                        initMap();
                    }
                });

                // Áõ£ËÅΩÂ§©Êï∏ÂàáÊèõÊôÇÔºåËã•Âú®Âú∞ÂúñÊ®°ÂºèÔºåÈáçÊñ∞Áπ™Ë£Ω
                watch(currentDayIdx, () => {
                    if (viewMode.value === 'map') {
                        initMap();
                    }
                });

                // ÂàùÂßãÂåñ & ÂÑ≤Â≠òÈÇèËºØ
                onMounted(() => {
                    fetchTokyoWeather(); 

                    // 1. ÂÖàÂòóË©¶ËÆÄÂèñ LocalStorage (ÂñÆÊ©üÂÑ™ÂÖà)
                    // Êõ¥Êèõ key ÁÇ∫ v5 Âº∑Âà∂Êõ¥Êñ∞Ë≥áÊñô
                    const localDays = localStorage.getItem('tokyo_days_v5');
                    const localExp = localStorage.getItem('tokyo_exp_v5');
                    const localRate = localStorage.getItem('tokyo_rate_v5'); 
                    
                    if (localDays) days.value = JSON.parse(localDays);
                    if (localExp) expenses.value = JSON.parse(localExp);
                    if (localRate) exchangeRate.value = parseFloat(localRate);

                    // 2. ÂïüÂãï Firebase Âç≥ÊôÇÁõ£ËÅΩ
                    if (typeof initializeApp !== 'undefined' && typeof firebaseConfig !== 'undefined') {
                        try {
                            const app = initializeApp(firebaseConfig);
                            const db = getFirestore(app);
                            const tripRef = doc(db, "trips", "tokyo_2025_v5"); // Áî®ÁâπÂÆöÁöÑ ID
                            
                            onSnapshot(tripRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    // Èõ≤Á´ØÊúâË≥áÊñôÊâçÂêåÊ≠•ÔºåÈÄôË£°ÂÖàÁî±Èõ≤Á´ØË¶ÜËìãÊú¨Âú∞ÔºåÁ¢∫‰øùÂ§ö‰∫∫‰∏ÄËá¥
                                    days.value = data.days;
                                    expenses.value = data.expenses;
                                    if(data.exchangeRate) exchangeRate.value = data.exchangeRate;
                                    isOnline.value = true;
                                    isFirebaseReady.value = true; // Ëß£ÈéñÂØ´ÂÖ•
                                } else {
                                    // Èõ≤Á´ØÁÑ°Ë≥áÊñô (Êñ∞ ID v5)ÔºåÁ´ãÂàªÂØ´ÂÖ•ÂàùÂßãË≥áÊñô
                                    setDoc(tripRef, {
                                        days: JSON.parse(JSON.stringify(days.value)),
                                        expenses: JSON.parse(JSON.stringify(expenses.value)),
                                        exchangeRate: exchangeRate.value
                                    });
                                    isOnline.value = true;
                                    isFirebaseReady.value = true; // Ëß£ÈéñÂØ´ÂÖ•
                                }
                            });

                            // Áõ£ËÅΩËÆäÊõ¥‰∏¶‰∏äÂÇ≥
                            watch([days, expenses, exchangeRate], async () => {
                                if (isFirebaseReady.value) { // Âè™ÊúâÁï∂Ê∫ñÂÇôÂ•ΩÂæåÊâçÂØ´ÂÖ•ÔºåÈÅøÂÖçÁ©∫Ë≥áÊñôË¶ÜËìã
                                    await setDoc(tripRef, {
                                        days: JSON.parse(JSON.stringify(days.value)),
                                        expenses: JSON.parse(JSON.stringify(expenses.value)),
                                        exchangeRate: exchangeRate.value
                                    });
                                }
                            }, { deep: true });

                        } catch (e) {
                            console.log("Firebase Â∞öÊú™Ë®≠ÂÆöÊàñÈåØË™§", e);
                        }
                    } else {
                        // Á¥îÂñÆÊ©üÊ®°ÂºèÔºöÁõ£ËÅΩ‰∏¶Â≠ò LocalStorage
                        watch([days, expenses, exchangeRate], () => {
                            localStorage.setItem('tokyo_days_v5', JSON.stringify(days.value));
                            localStorage.setItem('tokyo_exp_v5', JSON.stringify(expenses.value));
                            localStorage.setItem('tokyo_rate_v5', exchangeRate.value.toString());
                        }, { deep: true });
                    }
                });

                return {
                    viewMode, currentDayIdx, days, currentDay, participants,
                    getGoogleMapLink, addItem, removeItem, removeCurrentDay, addDay,
                    expenses, newExpense, totalExpense, addExpense, removeExpense,
                    paidByPerson, settlementPlan, exchangeRate,
                    isOnline, getTimePeriod, weather,
                    isMapLoading, userLocation, initMap, centerOnUser,
                    foodRecommendations, fillFood
                };
            }
        }).mount('#app')
    </script>
</body>
</html>
